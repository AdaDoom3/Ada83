CHECKLIST: Ada83 Compiler Refactoring via ACATS C-Series Tests
=============================================================

ORIGINAL PROMPT:
  In the pursuit of high-quality code (low line count (e.g. low undue
  complexity) and high feature/correctness) - refactor and fix ada83.c to
  pass a C-test group completely (e.g. cXX) with much better Haskell-like
  C99 and tight smart code-golfing with, ironically, textbook "Literate
  Programming" style. Use the GNAT LLVM source to see what is done there
  before making changes.

  Create a file to track everything called "checklist.txt" and include this
  prompt in it. Start with c43. Test exclusively with run_acats.sh

  Use the C-series tests (done in batches) to guide you. MAKE SURE TO STORE
  RESULTS IN THE REPO TO AVOID WASTING TIME - EACH RUN TAKES OVER A MIN!
  JUST SLOG THROUGH THEM, PICK AN ISSUE, FIX IT IN FULL THEN MOVE ON - NO
  DANCING AROUND FINDING "SIMPLE" OR "EASY" WINS. NO USING THE WORD
  "COMPLEX" - EVER.

APPROACH:
  1. Run c43 tests, store results
  2. Study GNAT LLVM source for relevant constructs
  3. Pick first failure, understand it fully, fix it
  4. Re-run tests, store results, repeat
  5. Refactor toward Haskell-like C99 style as we go

===========================================================================
TEST GROUP: c43
===========================================================================

--- RUN 1 (baseline) ---
Date: 2026-02-05 23:06
Results: 20 pass / 17 fail / 16 skip = 37% (53 total)

FAILURES:
  c43004b  - CONSTRAINT_ERROR not raised (aggregate with wrong discriminant?)
  c43204a  - RUNTIME timeout (exit 124)
  c43204e  - RUNTIME timeout (exit 124)
  c43204f  - UNEXPECTED CONSTRAINT_ERROR
  c43204g  - RUNTIME timeout (exit 124)
  c43204i  - RUNTIME timeout (exit 124)
  c43205f  - CONSTRAINT_ERROR not raised (case F1)
  c43205g  - Array wrong values (case A1)
  c43205i  - Lower bound incorrect for FIRST
  c43207a  - CONSTRAINT_ERROR not raised (case A1)
  c43207b  - Array not bounded correctly (case B1)
  c43211a  - Incorrect values (case A)
  c43212a  - CONSTRAINT_ERROR not raised (case 1)
  c43213a  - CONSTRAINT_ERROR not raised (case 1)
  c43214a  - CONSTRAINT_ERROR not raised (case A)
  c43214b  - Lower bound incorrect (case 1)
  c43214d  - RUNTIME timeout (exit 124)

SKIPS: (16 total - all pre-existing)
  c43004c, c43103b, c43106a, c43204c, c43204h  - BIND: unresolved symbols
  c43205b, c43205h  - COMPILE: untyped aggregate
  c43205e  - COMPILE: concatenation required
  c43205j, c43205k, c43212c, c43214c, c43214e, c43214f, c43222a  - BIND
  c43224a  - COMPILE: (empty error)

--- RUN 10 (latest) ---
Date: 2026-02-06 12:34
Results: 32 pass / 5 fail / 16 skip = 60% (53 total)

FIXES APPLIED (in order):
  1. Fat pointer bounds for constrained formals (RM 4.3.2)
     - Rebuild fat pointer when passing string literals/slices to
       constrained formal parameters (e.g. STRING(11..15))
  2. Fat pointer return lifetime
     - Copy returned dynamic array data to caller-local alloca to
       prevent dangling pointers after callee stack is freed
  3. Aggregate constraint checks (RM 4.3.2(6))
     - Positional aggregate bounds vs constraint check
     - Named aggregate bounds vs constraint check
     - Moved n_positional/has_named to outer scope for reuse
  4. setjmp returns_twice / longjmp noreturn (CRITICAL)
     - Without returns_twice, LLVM optimizer eliminated the second
       return path from setjmp, breaking ALL exception handling
     - This single fix turned ~10 tests from FAIL to PASS
  5. Dynamic aggregate index subtype check (RM 4.3.2(3))
     - Runtime check that range choice bounds belong to the named
       index type (e.g. STA RANGE 4..7)
  6. Row size clamping
     - Clamp dynamic rt_row_size to non-negative for null inner dims

NEWLY PASSING (12 tests flipped from FAIL to PASS):
  c43204a, c43204e, c43205f, c43205g, c43205i, c43207a,
  c43207b, c43211a, c43213a, c43214a, c43214b, c43214d

REMAINING FAILURES (5):
  c43004b  - Component aggregate bounds not checked against record
             discriminant-dependent or dynamic subtype constraints
  c43204f  - Spurious CONSTRAINT_ERROR in default parameter aggregate
             with dynamic bounds and OTHERS clause
  c43204g  - RUNTIME timeout: uses Ada tasks (concurrency) not fully
             supported by the runtime
  c43204i  - RUNTIME timeout: uses Ada tasks (same as c43204g)
  c43212a  - Subaggregate bounds consistency not checked (row 2 has
             different inner bounds than rows 1 and 3)

