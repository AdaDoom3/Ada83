int mx=g->sm->eo;
if(mx>0)fprintf(g->o,"  %%__frame = alloca [%d x ptr]\n",mx);
}
static void gdl(Gn*g,No*n);
static V vcast(Gn*g,V v,Vk k){if(v.k==k)return v;V r={nt(g),k};if(v.k==VK_I&&k==VK_F)fprintf(g->o,"  %%t%d = sitofp i64 %%t%d to double\n",r.id,v.id);else if(v.k==VK_F&&k==VK_I)fprintf(g->o,"  %%t%d = fptosi double %%t%d to i64\n",r.id,v.id);else if(v.k==VK_P&&k==VK_I)fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",r.id,v.id);else if(v.k==VK_I&&k==VK_P)fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",r.id,v.id);else fprintf(g->o,"  %%t%d = bitcast %s %%t%d to %s\n",r.id,vt(v.k),v.id,vt(k));return r;}
static V vbool(Gn*g,V v){if(v.k!=VK_I)v=vcast(g,v,VK_I);int t=nt(g);V c={nt(g),VK_I};fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",t,v.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",c.id,t);return c;}
static V vcmpi(Gn*g,const char*op,V a,V b){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);int c=nt(g);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = icmp %s i64 %%t%d, %%t%d\n",c,op,a.id,b.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,c);return r;}
static V vcmpf(Gn*g,const char*op,V a,V b){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);int c=nt(g);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = fcmp %s double %%t%d, %%t%d\n",c,op,a.id,b.id);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,c);return r;}
static V vpowi(Gn*g,V a,V b){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);V r={nt(g),VK_I};fprintf(g->o,"  %%t%d = call i64 @__ada_powi(i64 %%t%d, i64 %%t%d)\n",r.id,a.id,b.id);return r;}
static V vpows(Gn*g,V a,V b){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);V r={nt(g),VK_F};fprintf(g->o,"  %%t%d = call double @pow(double %%t%d, double %%t%d)\n",r.id,a.id,b.id);return r;}
static V gag(Gn*g,No*n,Ty*ty){V r={nt(g),VK_P};Ty*t=ty?tcc(ty):0;if(!t||t->k!=TY_R||t->pk){int sz=n->ag.it.n?n->ag.it.n:1;int p=nt(g);fprintf(g->o,"  %%t%d = alloca [%d x i64]\n",p,sz);uint32_t ix=0;for(uint32_t i=0;i<n->ag.it.n;i++){No*el=n->ag.it.d[i];if(el->k==N_ASC){if(el->asc.ch.d[0]->k==N_ID&&si(el->asc.ch.d[0]->s,Z("others"))){for(;ix<(uint32_t)sz;ix++){V v=vcast(g,gex(g,el->asc.vl),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}}else{V v=vcast(g,gex(g,el->asc.vl),VK_I);for(uint32_t j=0;j<el->asc.ch.n;j++){V ci=vcast(g,gex(g,el->asc.ch.d[j]),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %%t%d\n",ep,sz,p,ci.id);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}ix++;}}else{V v=vcast(g,gex(g,el),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);ix++;}}fprintf(g->o,"  %%t%d = getelementptr [%d x i64], ptr %%t%d, i64 0, i64 0\n",r.id,sz,p);}else{uint32_t sz=t->sz/8;int p=nt(g);fprintf(g->o,"  %%t%d = alloca [%u x i64]\n",p,sz);uint32_t ix=0;for(uint32_t i=0;i<n->ag.it.n;i++){No*el=n->ag.it.d[i];if(el->k==N_ASC){for(uint32_t j=0;j<el->asc.ch.n;j++){No*ch=el->asc.ch.d[j];if(ch->k==N_ID){for(uint32_t k=0;k<t->cm.n;k++){No*c=t->cm.d[k];if(c->k==N_CM&&si(c->cm.nm,ch->s)){V v=vcast(g,gex(g,el->asc.vl),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,c->cm.of);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);break;}}}}ix++;}else{V v=vcast(g,gex(g,el),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 %u\n",ep,sz,p,ix);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);ix++;}}fprintf(g->o,"  %%t%d = getelementptr [%u x i64], ptr %%t%d, i64 0, i64 0\n",r.id,sz,p);}return r;}
static No*sbody(Sy*s,int el){if(!s||s->ol.n==0)return 0;for(uint32_t i=0;i<s->ol.n;i++){No*b=s->ol.d[i];if((b->k==N_PB||b->k==N_FB)&&b->bd.el==el)return b;}return s->ol.d[0];}
static V gex(Gn*g,No*n){if(!n)return(V){0,VK_I};V r={nt(g),tk2v(n->ty)};switch(n->k){case N_INT:r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)n->i);break;case N_REAL:r.k=VK_F;fprintf(g->o,"  %%t%d = fadd double 0.0, %e\n",r.id,n->f);break;case N_CHAR:r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %d\n",r.id,(int)n->i);break;case N_STR:r.k=VK_P;{int p=nt(g);fprintf(g->o,"  %%t%d = alloca [%u x i8]\n",p,n->s.n+1);fprintf(g->o,"  store [%u x i8] c\"",n->s.n+1);for(uint32_t i=0;i<n->s.n;i++){char c=n->s.s[i];if(c=='"')fprintf(g->o,"\\22");else if(c=='\\')fprintf(g->o,"\\5C");else if(c<32||c>126)fprintf(g->o,"\\%02X",(unsigned char)c);else fprintf(g->o,"%c",c);}fprintf(g->o,"\\00\", ptr %%t%d\n",p);fprintf(g->o,"  %%t%d = getelementptr [%u x i8], ptr %%t%d, i64 0, i64 0\n",r.id,n->s.n+1,p);}break;case N_NULL:r.k=VK_P;fprintf(g->o,"  %%t%d = inttoptr i64 0 to ptr\n",r.id);break;case N_ID:{Sy*s=n->sy?n->sy:syf(g->sm,n->s);if(s&&s->k==2){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)s->vl);}else{Vk k=VK_I;if(s&&s->ty)k=tk2v(s->ty);r.k=k;if(s&&s->lv==0){char nb[256];if(s->pr&&s->pr->nm.s){int n=0;for(uint32_t i=0;i<s->pr->nm.n;i++)nb[n++]=toupper(s->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<s->nm.n;i++)nb[n++]=toupper(s->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)s->nm.n,s->nm.s);if(s->k==5){No*b=sbody(s,s->el);No*sp=b?b->bd.sp:0;if(sp&&sp->sp.pmm.n==0){char fnb[256];esn(fnb,256,s,n->s);fprintf(g->o,"  %%t%d = call %s @\"%s\"()\n",r.id,vt(k),fnb);}else fprintf(g->o,"  %%t%d = load %s, ptr @%s\n",r.id,vt(k),nb);}else fprintf(g->o,"  %%t%d = load %s, ptr @%s\n",r.id,vt(k),nb);}else if(s&&s->lv>=0&&s->lv<g->sm->lv){
int p=nt(g);
fprintf(g->o,"  %%t%d = getelementptr ptr, ptr %%__slnk, i64 %u\n",p,s->el);
int a=nt(g);
fprintf(g->o,"  %%t%d = load ptr, ptr %%t%d\n",a,p);
fprintf(g->o,"  %%t%d = load %s, ptr %%t%d\n",r.id,vt(k),a);
}else{Ty*vat=s&&s->ty?tcc(s->ty):0;if(vat&&vat->k==TY_A){fprintf(g->o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",r.id,LC(n->s),s?s->sc:0,s?s->el:0);}else{fprintf(g->o,"  %%t%d = load %s, ptr %%v.%s.sc%u.%u\n",r.id,vt(k),LC(n->s),s?s->sc:0,s?s->el:0);}}}}break;case N_BIN:{Tk op=n->bn.op;if(op==T_ATHN||op==T_OREL){V lv=vbool(g,gex(g,n->bn.l));int c=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c,lv.id);int lt=nl(g),lf=nl(g),ld=nl(g);if(op==T_ATHN)fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",c,lt,lf);else fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",c,lf,lt);fprintf(g->o,"L%d:\n",lt);V rv=vbool(g,gex(g,n->bn.r));fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lf);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",ld);r.k=VK_I;fprintf(g->o,"  %%t%d = phi i64 [%s,%%L%d],[%%t%d,%%L%d]\n",r.id,op==T_ATHN?"0":"1",lf,rv.id,lt);break;}if(op==T_AND||op==T_OR||op==T_XOR){V a=vbool(g,gex(g,n->bn.l));V b=vbool(g,gex(g,n->bn.r));r.k=VK_I;if(op==T_AND)fprintf(g->o,"  %%t%d = and i64 %%t%d, %%t%d\n",r.id,a.id,b.id);else if(op==T_OR)fprintf(g->o,"  %%t%d = or i64 %%t%d, %%t%d\n",r.id,a.id,b.id);else fprintf(g->o,"  %%t%d = xor i64 %%t%d, %%t%d\n",r.id,a.id,b.id);break;}if(op==T_NOT){V x=vcast(g,gex(g,n->bn.l),VK_I);No*rr=n->bn.r;while(rr&&rr->k==N_CHK)rr=rr->chk.ex;if(rr&&rr->k==N_RN){V lo=vcast(g,gex(g,rr->rn.lo),VK_I),hi=vcast(g,gex(g,rr->rn.hi),VK_I);V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(g->o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);int xr=nt(g);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",xr,a1);r.k=VK_I;fprintf(g->o,"  %%t%d = xor i64 %%t%d, 1\n",r.id,xr);}else if(rr&&rr->k==N_ID){Sy*s=rr->sy?rr->sy:syf(g->sm,rr->s);if(s&&s->ty){Ty*t=tcc(s->ty);if(t){int tlo=nt(g);fprintf(g->o,"  %%t%d = add i64 0, %lld\n",tlo,(long long)t->lo);int thi=nt(g);fprintf(g->o,"  %%t%d = add i64 0, %lld\n",thi,(long long)t->hi);V lo={tlo,VK_I},hi={thi,VK_I};V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(g->o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);int xr=nt(g);fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",xr,a1);r.k=VK_I;fprintf(g->o,"  %%t%d = xor i64 %%t%d, 1\n",r.id,xr);}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 1\n",r.id);}break;}if(op==T_IN){V x=vcast(g,gex(g,n->bn.l),VK_I);No*rr=n->bn.r;while(rr&&rr->k==N_CHK)rr=rr->chk.ex;if(rr&&rr->k==N_RN){V lo=vcast(g,gex(g,rr->rn.lo),VK_I),hi=vcast(g,gex(g,rr->rn.hi),VK_I);V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(g->o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);r.k=VK_I;fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,a1);}else if(rr&&rr->k==N_ID){Sy*s=rr->sy?rr->sy:syf(g->sm,rr->s);if(s&&s->ty){Ty*t=tcc(s->ty);if(t){int tlo=nt(g);fprintf(g->o,"  %%t%d = add i64 0, %lld\n",tlo,(long long)t->lo);int thi=nt(g);fprintf(g->o,"  %%t%d = add i64 0, %lld\n",thi,(long long)t->hi);V lo={tlo,VK_I},hi={thi,VK_I};V ge=vcmpi(g,"sge",x,lo);V le=vcmpi(g,"sle",x,hi);V b1=vbool(g,ge),b2=vbool(g,le);int c1=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c1,b1.id);int c2=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",c2,b2.id);int a1=nt(g);fprintf(g->o,"  %%t%d = and i1 %%t%d, %%t%d\n",a1,c1,c2);r.k=VK_I;fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,a1);}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}break;}V a=gex(g,n->bn.l),b=gex(g,n->bn.r);if(op==T_EX){if(b.k==VK_F){int bc=nt(g);fprintf(g->o,"  %%t%d = fptosi double %%t%d to i64\n",bc,b.id);b.id=bc;b.k=VK_I;}V bi=vcast(g,b,VK_I);int cf=nt(g);fprintf(g->o,"  %%t%d = icmp slt i64 %%t%d, 0\n",cf,bi.id);int lt=nl(g),lf=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",cf,lt,lf);fprintf(g->o,"L%d:\n",lt);fprintf(g->o,"  call void @__ada_raise(ptr @.ex.CONSTRAINT_ERROR)\n  unreachable\nL%d:\n",lf);if(tk2v(n->ty)==VK_F){r=vpows(g,a,b);}else{r=vpowi(g,a,bi);}break;}if(op==T_PL||op==T_MN||op==T_ST||op==T_SL){if(a.k==VK_F||b.k==VK_F){a=vcast(g,a,VK_F);b=vcast(g,b,VK_F);r.k=VK_F;fprintf(g->o,"  %%t%d = %s double %%t%d, %%t%d\n",r.id,op==T_PL?"fadd":op==T_MN?"fsub":op==T_ST?"fmul":"fdiv",a.id,b.id);}else{a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);r.k=VK_I;fprintf(g->o,"  %%t%d = %s i64 %%t%d, %%t%d\n",r.id,op==T_PL?"add":op==T_MN?"sub":op==T_ST?"mul":"sdiv",a.id,b.id);}break;}if(op==T_MOD||op==T_REM){a=vcast(g,a,VK_I);b=vcast(g,b,VK_I);r.k=VK_I;fprintf(g->o,"  %%t%d = srem i64 %%t%d, %%t%d\n",r.id,a.id,b.id);break;}if(op==T_EQ||op==T_NE||op==T_LT||op==T_LE||op==T_GT||op==T_GE){if((op==T_EQ||op==T_NE)&&(n->bn.l->k==N_STR||n->bn.r->k==N_STR||(n->bn.l->ty&&tcc(n->bn.l->ty)->el&&tcc(n->bn.l->ty)->el->k==TY_C)||(n->bn.r->ty&&tcc(n->bn.r->ty)->el&&tcc(n->bn.r->ty)->el->k==TY_C))){V ap=a,bp=b;if(ap.k==VK_I){int p1=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",p1,ap.id);ap.id=p1;ap.k=VK_P;}if(bp.k==VK_I){int p2=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",p2,bp.id);bp.id=p2;bp.k=VK_P;}int cmp=nt(g);fprintf(g->o,"  %%t%d = call i32 @strcmp(ptr %%t%d, ptr %%t%d)\n",cmp,ap.id,bp.id);int eq=nt(g);fprintf(g->o,"  %%t%d = icmp %s i32 %%t%d, 0\n",eq,op==T_EQ?"eq":"ne",cmp);r.k=VK_I;fprintf(g->o,"  %%t%d = zext i1 %%t%d to i64\n",r.id,eq);break;}if(a.k==VK_F||b.k==VK_F){const char*cc=op==T_EQ?"oeq":op==T_NE?"one":op==T_LT?"olt":op==T_LE?"ole":op==T_GT?"ogt":"oge";r=vcmpf(g,cc,a,b);}else{const char*cc=op==T_EQ?"eq":op==T_NE?"ne":op==T_LT?"slt":op==T_LE?"sle":op==T_GT?"sgt":"sge";r=vcmpi(g,cc,a,b);}break;}if(op==T_AM&&(a.k==VK_P||b.k==VK_P)){a=vcast(g,a,VK_P);b=vcast(g,b,VK_P);int la=nt(g),lb=nt(g);fprintf(g->o,"  %%t%d = call i64 @strlen(ptr %%t%d)\n",la,a.id);fprintf(g->o,"  %%t%d = call i64 @strlen(ptr %%t%d)\n",lb,b.id);int sz=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, %%t%d\n",sz,la,lb);int sz1=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, 1\n",sz1,sz);int np=nt(g);fprintf(g->o,"  %%t%d = call ptr @malloc(i64 %%t%d)\n",np,sz1);fprintf(g->o,"  call void @llvm.memcpy.p0.p0.i64(ptr %%t%d, ptr %%t%d, i64 %%t%d, i1 false)\n",np,a.id,la);int dp=nt(g);fprintf(g->o,"  %%t%d = getelementptr i8, ptr %%t%d, i64 %%t%d\n",dp,np,la);fprintf(g->o,"  call void @llvm.memcpy.p0.p0.i64(ptr %%t%d, ptr %%t%d, i64 %%t%d, i1 false)\n",dp,b.id,lb);int zp=nt(g);fprintf(g->o,"  %%t%d = getelementptr i8, ptr %%t%d, i64 %%t%d\n",zp,np,sz);fprintf(g->o,"  store i8 0, ptr %%t%d\n",zp);r.k=VK_P;r.id=np;break;}r.k=VK_I;{V ai=vcast(g,a,VK_I),bi=vcast(g,b,VK_I);fprintf(g->o,"  %%t%d = add i64 %%t%d, %%t%d\n",r.id,ai.id,bi.id);}break;}break;case N_UN:{V x=gex(g,n->un.x);if(n->un.op==T_MN){if(x.k==VK_F){r.k=VK_F;fprintf(g->o,"  %%t%d = fsub double 0.0, %%t%d\n",r.id,x.id);}else{x=vcast(g,x,VK_I);r.k=VK_I;fprintf(g->o,"  %%t%d = sub i64 0, %%t%d\n",r.id,x.id);}break;}if(n->un.op==T_NOT){V b=vbool(g,x);r.k=VK_I;fprintf(g->o,"  %%t%d = xor i64 %%t%d, 1\n",r.id,b.id);break;}if(n->un.op==T_ABS){if(x.k==VK_F){V z=vcast(g,x,VK_F);int c=nt(g);fprintf(g->o,"  %%t%d = fcmp olt double %%t%d, 0.0\n",c,z.id);V ng={nt(g),VK_F};fprintf(g->o,"  %%t%d = fsub double 0.0, %%t%d\n",ng.id,z.id);r.k=VK_F;fprintf(g->o,"  %%t%d = select i1 %%t%d, double %%t%d, double %%t%d\n",r.id,c,ng.id,z.id);}else{V z=vcast(g,x,VK_I);int c=nt(g);fprintf(g->o,"  %%t%d = icmp slt i64 %%t%d, 0\n",c,z.id);V ng={nt(g),VK_I};fprintf(g->o,"  %%t%d = sub i64 0, %%t%d\n",ng.id,z.id);r.k=VK_I;fprintf(g->o,"  %%t%d = select i1 %%t%d, i64 %%t%d, i64 %%t%d\n",r.id,c,ng.id,z.id);}break;}r=vcast(g,x,r.k);break;}break;case N_IX:{V p=gex(g,n->ix.p);if(p.k==VK_I){int pp=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,p.id);p.id=pp;p.k=VK_P;}V i0=vcast(g,gex(g,n->ix.ix.d[0]),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",ep,p.id,i0.id);Ty*et=n->ty?tcc(n->ty):0;if(et&&(et->k==TY_A||et->k==TY_R)){r.k=VK_P;r.id=ep;}else{r.k=VK_I;fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);}}break;case N_SL:{V p=gex(g,n->sl.p);V lo=vcast(g,gex(g,n->sl.lo),VK_I);V hi=vcast(g,gex(g,n->sl.hi),VK_I);int ln=nt(g);fprintf(g->o,"  %%t%d = sub i64 %%t%d, %%t%d\n",ln,hi.id,lo.id);int sz=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, 1\n",sz,ln);int sl=nt(g);fprintf(g->o,"  %%t%d = mul i64 %%t%d, 8\n",sl,sz);int ap=nt(g);fprintf(g->o,"  %%t%d = alloca i8, i64 %%t%d\n",ap,sl);int sp=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",sp,p.id,lo.id);fprintf(g->o,"  call void @llvm.memcpy.p0.p0.i64(ptr %%t%d, ptr %%t%d, i64 %%t%d, i1 false)\n",ap,sp,sl);r.k=VK_P;fprintf(g->o,"  %%t%d = bitcast ptr %%t%d to ptr\n",r.id,ap);}break;case N_SEL:{Ty*pt=n->se.p->ty?tcc(n->se.p->ty):0;V p={nt(g),VK_P};if(n->se.p->k==N_ID){Sy*s=n->se.p->sy?n->se.p->sy:syf(g->sm,n->se.p->s);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  %%t%d = bitcast ptr %%lnk.%d.%.*s to ptr\n",p.id,s->lv,(int)n->se.p->s.n,n->se.p->s.s);else fprintf(g->o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",p.id,LC(n->se.p->s),s?s->sc:0,s?s->el:0);}else{p=gex(g,n->se.p);}if(pt&&pt->k==TY_R){for(uint32_t i=0;i<pt->dc.n;i++){No*d=pt->dc.d[i];S dn=d->k==N_DS?d->pm.nm:d->cm.nm;if(si(dn,n->se.se)){int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,i);r.k=VK_I;fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);goto sel_done;}}if(pt->pk){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){int bp=nt(g);fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",bp,p.id);int bo=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, %u\n",bo,bp,c->cm.of/8);int pp=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,bo);int vp=nt(g);fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",vp,pp);int sh=nt(g);fprintf(g->o,"  %%t%d = lshr i64 %%t%d, %u\n",sh,vp,c->cm.of%8);int ms=nt(g);uint64_t mk=(1ULL<<c->cm.bt)-1;r.k=VK_I;fprintf(g->o,"  %%t%d = and i64 %%t%d, %llu\n",r.id,sh,(unsigned long long)mk);break;}}}else{for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,c->cm.of);r.k=VK_I;fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",r.id,ep);break;}}}sel_done:;}else if(n->sy&&n->sy->k==2){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)n->sy->vl);}else{r=vcast(g,p,r.k);}}break;case N_AT:{S a=n->at.at;Ty*t=n->at.p?tcc(n->at.p->ty):0;if(si(a,Z("ADDRESS"))){V p=gex(g,n->at.p);r.k=VK_I;fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",r.id,vcast(g,p,VK_P).id);}else if(si(a,Z("SIZE"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,t?(long long)(t->sz*8):64LL);}else if(si(a,Z("FIRST"))||si(a,Z("LAST"))||si(a,Z("LENGTH"))){if(n->at.ar.n>0)gex(g,n->at.ar.d[0]);int64_t lo=0,hi=-1;if(t&&t->k==TY_A){lo=t->lo;hi=t->hi;}else if(t&&(t->k==TY_I||t->k==TY_UI||t->k==TY_E||t->k==TY_D)){lo=t->lo;hi=t->hi;}int64_t v=si(a,Z("FIRST"))?lo:si(a,Z("LAST"))?hi:(hi>=lo?hi-lo+1:0);r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)v);}else if(si(a,Z("POS"))){V x=gex(g,n->at.ar.d[0]);if(t&&t->k==TY_E){r=vcast(g,x,VK_I);}else{r.k=VK_I;int tlo=nt(g);fprintf(g->o,"  %%t%d = add i64 0, %lld\n",tlo,t?(long long)t->lo:0LL);fprintf(g->o,"  %%t%d = sub i64 %%t%d, %%t%d\n",r.id,vcast(g,x,VK_I).id,tlo);}}else if(si(a,Z("VAL"))){V x=gex(g,n->at.ar.d[0]);r.k=VK_I;int tlo=nt(g);fprintf(g->o,"  %%t%d = add i64 0, %lld\n",tlo,t?(long long)t->lo:0LL);fprintf(g->o,"  %%t%d = add i64 %%t%d, %%t%d\n",r.id,vcast(g,x,VK_I).id,tlo);}else if(si(a,Z("SUCC"))||si(a,Z("PRED"))){V x=gex(g,n->at.ar.d[0]);r.k=VK_I;fprintf(g->o,"  %%t%d = %s i64 %%t%d, 1\n",r.id,si(a,Z("SUCC"))?"add":"sub",vcast(g,x,VK_I).id);}else if(si(a,Z("IMAGE"))){V x=gex(g,n->at.ar.d[0]);r.k=VK_P;if(t&&t->k==TY_E){fprintf(g->o,"  %%t%d = call ptr @__ada_image_enum(i64 %%t%d, i64 %lld, i64 %lld)\n",r.id,vcast(g,x,VK_I).id,t?(long long)t->lo:0LL,t?(long long)t->hi:127LL);}else{fprintf(g->o,"  %%t%d = call ptr @__ada_image_int(i64 %%t%d)\n",r.id,vcast(g,x,VK_I).id);}}else if(si(a,Z("VALUE"))){V x=gex(g,n->at.ar.d[0]);r.k=VK_I;fprintf(g->o,"  %%t%d = call i64 @__ada_value_int(ptr %%t%d)\n",r.id,vcast(g,x,VK_P).id);}else if(si(a,Z("DIGITS"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,t?(long long)t->sm:15LL);}else if(si(a,Z("DELTA"))){r.k=VK_F;fprintf(g->o,"  %%t%d = fadd double 0.0, %e\n",r.id,t?1.0/pow(2.0,(double)t->sm):0.01);}else if(si(a,Z("SMALL"))||si(a,Z("LARGE"))||si(a,Z("EPSILON"))){r.k=VK_F;double v=si(a,Z("SMALL"))?pow(2.0,-126.0):si(a,Z("LARGE"))?1.0e308:pow(2.0,t?-(double)t->sm:-52.0);fprintf(g->o,"  %%t%d = fadd double 0.0, %e\n",r.id,v);}else if(si(a,Z("MANTISSA"))||si(a,Z("MACHINE_MANTISSA"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,t?(long long)t->sm:53LL);}else if(si(a,Z("MACHINE_RADIX"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 2\n",r.id);}else if(si(a,Z("EMAX"))||si(a,Z("MACHINE_EMAX"))||si(a,Z("SAFE_EMAX"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 1024\n",r.id);}else if(si(a,Z("MACHINE_EMIN"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, -1021\n",r.id);}else if(si(a,Z("MACHINE_OVERFLOWS"))||si(a,Z("MACHINE_ROUNDS"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 1\n",r.id);}else if(si(a,Z("AFT"))){r.k=VK_I;int64_t dg=1;if(t&&t->sm>0){while(pow(10.0,(double)dg)*pow(2.0,-(double)t->sm)<1.0)dg++;}fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)dg);}else if(si(a,Z("FORE"))){r.k=VK_I;int64_t fw=2;if(t&&t->hi>0){int64_t mx=t->hi;while(mx>=10){mx/=10;fw++;}}fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)fw);}else if(si(a,Z("WIDTH"))){r.k=VK_I;int64_t wd=1;if(t){if(t->k==TY_E){for(uint32_t i=0;i<t->ev.n;i++){Sy*e=t->ev.d[i];int64_t ln=e->nm.n;if(ln>wd)wd=ln;}}else{int64_t mx=t->hi>-t->lo?t->hi:-t->lo;while(mx>=10){mx/=10;wd++;}if(t->lo<0)wd++;}}fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)wd);}else if(si(a,Z("STORAGE_SIZE"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,t?(long long)(t->sz*8):0LL);}else if(si(a,Z("POSITION"))||si(a,Z("FIRST_BIT"))||si(a,Z("LAST_BIT"))){r.k=VK_I;int64_t v=0;if(n->at.p&&n->at.p->k==N_SEL){Ty*pt=n->at.p->se.p->ty?tcc(n->at.p->se.p->ty):0;if(pt&&pt->k==TY_R){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->at.p->se.se)){if(pt->pk){if(si(a,Z("POSITION")))v=c->cm.of/8;else if(si(a,Z("FIRST_BIT")))v=c->cm.of%8;else if(si(a,Z("LAST_BIT")))v=(c->cm.of%8)+c->cm.bt-1;}else{if(si(a,Z("POSITION")))v=i*8;else if(si(a,Z("FIRST_BIT")))v=0;else if(si(a,Z("LAST_BIT")))v=63;}break;}}}}fprintf(g->o,"  %%t%d = add i64 0, %lld\n",r.id,(long long)v);}else if(si(a,Z("CONSTRAINED"))||si(a,Z("COUNT"))||si(a,Z("CALLABLE"))||si(a,Z("TERMINATED"))){r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}else if(si(a,Z("ACCESS"))){V p=gex(g,n->at.p);r=vcast(g,p,VK_P);}else if(si(a,Z("SAFE_LARGE"))||si(a,Z("SAFE_SMALL"))){r.k=VK_F;double v=si(a,Z("SAFE_LARGE"))?1.0e307:1.0e-307;fprintf(g->o,"  %%t%d = fadd double 0.0, %e\n",r.id,v);}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}break;}break;case N_QL:{V q=gex(g,n->ql.ag);r=vcast(g,q,r.k);}break;case N_CL:{if(n->cl.fn->k==N_ID){Sy*s=syfa(g->sm,n->cl.fn->s,n->cl.ar.n,n->ty);if(s){if(si(s->nm,Z("CREATE"))||si(s->nm,Z("OPEN"))){r.k=VK_P;int md=n->cl.ar.n>1?gex(g,n->cl.ar.d[1]).id:0;fprintf(g->o,"  %%t%d = call ptr @__text_io_%s(i64 %d, ptr %%t%d)\n",r.id,si(s->nm,Z("CREATE"))?"create":"open",md,n->cl.ar.n>2?gex(g,n->cl.ar.d[2]).id:0);break;}if(si(s->nm,Z("CLOSE"))||si(s->nm,Z("DELETE"))){if(n->cl.ar.n>0){V f=gex(g,n->cl.ar.d[0]);fprintf(g->o,"  call void @__text_io_%s(ptr %%t%d)\n",si(s->nm,Z("CLOSE"))?"close":"delete",f.id);}break;}if(si(s->nm,Z("GET"))||si(s->nm,Z("GET_LINE"))){if(n->cl.ar.n>1){V f=gex(g,n->cl.ar.d[0]);r.k=VK_I;fprintf(g->o,"  %%t%d = call i64 @__text_io_get(ptr %%t%d)\n",r.id,f.id);}else{r.k=VK_I;fprintf(g->o,"  %%t%d = call i64 @__text_io_get(ptr @stdin)\n",r.id);}break;}if(si(s->nm,Z("PUT"))||si(s->nm,Z("PUT_LINE"))){if(n->cl.ar.n>1){V f=gex(g,n->cl.ar.d[0]);V v=gex(g,n->cl.ar.d[1]);fprintf(g->o,"  call void @__text_io_%s(ptr %%t%d, ",si(s->nm,Z("PUT"))?"put":"put_line",f.id);if(v.k==VK_I)fprintf(g->o,"i64 %%t%d)\n",v.id);else if(v.k==VK_F)fprintf(g->o,"double %%t%d)\n",v.id);else fprintf(g->o,"ptr %%t%d)\n",v.id);}else{V v=gex(g,n->cl.ar.d[0]);fprintf(g->o,"  call void @__text_io_%s(ptr @stdout, ",si(s->nm,Z("PUT"))?"put":"put_line");if(v.k==VK_I)fprintf(g->o,"i64 %%t%d)\n",v.id);else if(v.k==VK_F)fprintf(g->o,"double %%t%d)\n",v.id);else fprintf(g->o,"ptr %%t%d)\n",v.id);}break;}if(s->ty&&s->ty->k==TY_S){Vk rk=tk2v(s->ty->el);r.k=rk;No*b=sbody(s,s->el);No*sp=b?b->bd.sp:0;int arid[64];Vk ark[64];int arp[64];for(uint32_t i=0;i<n->cl.ar.n&&i<64;i++){No*pm=sp&&i<sp->sp.pmm.n?sp->sp.pmm.d[i]:0;V av=gex(g,n->cl.ar.d[i]);Vk ek=VK_I;bool rf=false;if(pm&&pm->sy&&pm->sy->ty){ek=tk2v(pm->sy->ty);if(pm->pm.md&2){rf=true;int ap=nt(g);fprintf(g->o,"  %%t%d = alloca %s\n",ap,vt(ek));fprintf(g->o,"  store %s %%t%d, ptr %%t%d\n",vt(ek),av.id,ap);av.id=ap;av.k=VK_P;ek=VK_P;}}if(!rf){V cv=vcast(g,av,ek);av=cv;}arid[i]=av.id;ark[i]=ek;arp[i]=i<sp->sp.pmm.n&&sp->sp.pmm.d[i]->pm.md&2?1:0;}char nb[256];esn(nb,256,s,n->cl.fn->s);fprintf(g->o,"  %%t%d = call %s @\"%s\"(",r.id,vt(rk),nb);for(uint32_t i=0;i<n->cl.ar.n;i++){if(i)fprintf(g->o,", ");fprintf(g->o,"%s %%t%d",vt(ark[i]),arid[i]);}if(s->lv>0){if(n->cl.ar.n>0)fprintf(g->o,", ");fprintf(g->o,"ptr %%__frame");}fprintf(g->o,")\n");for(uint32_t i=0;i<n->cl.ar.n&&i<64;i++){if(arp[i]){int lv=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%t%d\n",lv,vt(ark[i]==VK_P?VK_I:ark[i]),arid[i]);V rv={lv,ark[i]==VK_P?VK_I:ark[i]};V cv=vcast(g,rv,tk2v(n->cl.ar.d[i]->ty));No*tg=n->cl.ar.d[i];if(tg->k==N_ID){Sy*ts=tg->sy?tg->sy:syf(g->sm,tg->s);if(ts){if(ts->lv>=0&&ts->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(cv.k),cv.id,ts->lv,LC(tg->s));else fprintf(g->o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(cv.k),cv.id,LC(tg->s),ts->sc,ts->el);}}}}break;}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}}else{r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}break;}break;case N_AG:return gag(g,n,n->ty);case N_ALC:{r.k=VK_P;Ty*et=n->ty&&n->ty->el?tcc(n->ty->el):0;uint32_t asz=64;if(et&&et->dc.n>0)asz+=et->dc.n*8;fprintf(g->o,"  %%t%d = call ptr @malloc(i64 %u)\n",r.id,asz);if(n->alc.in){V v=gex(g,n->alc.in);v=vcast(g,v,VK_I);int op=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",op,r.id,et&&et->dc.n>0?(uint32_t)et->dc.n:0);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,op);}}break;case N_DRF:{V p=gex(g,n->drf.x);if(p.k==VK_I){int pp=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,p.id);p.id=pp;p.k=VK_P;}Ty*dt=n->drf.x->ty?tcc(n->drf.x->ty):0;dt=dt&&dt->el?tcc(dt->el):0;r.k=dt?tk2v(dt):VK_I;fprintf(g->o,"  %%t%d = load %s, ptr %%t%d\n",r.id,vt(r.k),p.id);}break;case N_CVT:{V e=gex(g,n->cvt.ex);r=vcast(g,e,r.k);}break;case N_CHK:{V e=gex(g,n->chk.ex);Ty*t=n->chk.ex->ty?tcc(n->chk.ex->ty):0;if(t&&t->k==TY_I&&(t->lo!=TY_INT->lo||t->hi!=TY_INT->hi)){int lok=nl(g),hik=nl(g),erl=nl(g),dn=nl(g);int lc=nt(g);fprintf(g->o,"  %%t%d = icmp sge i64 %%t%d, %lld\n",lc,e.id,(long long)t->lo);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",lc,lok,erl);fprintf(g->o,"L%d:\n",lok);int hc=nt(g);fprintf(g->o,"  %%t%d = icmp sle i64 %%t%d, %lld\n",hc,e.id,(long long)t->hi);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",hc,hik,erl);fprintf(g->o,"L%d:\n",hik);fprintf(g->o,"  br label %%L%d\n",dn);fprintf(g->o,"L%d:\n",erl);fprintf(g->o,"  call void @__ada_raise(ptr @.ex.%.*s)\n",(int)n->chk.ec.n,n->chk.ec.s);fprintf(g->o,"  unreachable\n");fprintf(g->o,"L%d:\n",dn);r=vcast(g,e,r.k);}else r=vcast(g,e,r.k);}break;case N_RN:{V lo=gex(g,n->rn.lo);r=vcast(g,lo,r.k);}break;default:r.k=VK_I;fprintf(g->o,"  %%t%d = add i64 0, 0\n",r.id);}return r;}
static void gss(Gn*g,No*n){if(!n)return;switch(n->k){case N_NS:fprintf(g->o,"  ; null\n");break;case N_AS:{V v=gex(g,n->as.vl);if(n->as.tg->k==N_ID){Sy*s=n->as.tg->sy;Vk k=s&&s->ty?tk2v(s->ty):VK_I;v=vcast(g,v,k);if(s&&s->lv==0){char nb[256];if(s->pr&&s->pr->nm.s){int n=0;for(uint32_t i=0;i<s->pr->nm.n;i++)nb[n++]=toupper(s->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<s->nm.n;i++)nb[n++]=toupper(s->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)s->nm.n,s->nm.s);fprintf(g->o,"  store %s %%t%d, ptr @%s\n",vt(k),v.id,nb);}else if(s&&s->lv>=0&&s->lv<g->sm->lv){
int p=nt(g);
fprintf(g->o,"  %%t%d = getelementptr ptr, ptr %%__slnk, i64 %u\n",p,s->el);
int a=nt(g);
fprintf(g->o,"  %%t%d = load ptr, ptr %%t%d\n",a,p);
fprintf(g->o,"  store %s %%t%d, ptr %%t%d\n",vt(k),v.id,a);
}else fprintf(g->o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v.id,LC(n->as.tg->s),s?s->sc:0,s?s->el:0);}else if(n->as.tg->k==N_IX){V p=gex(g,n->as.tg->ix.p);if(p.k==VK_I){int pp=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,p.id);p.id=pp;p.k=VK_P;}V i0=vcast(g,gex(g,n->as.tg->ix.ix.d[0]),VK_I);int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %%t%d\n",ep,p.id,i0.id);v=vcast(g,v,VK_I);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);}else if(n->as.tg->k==N_SEL){Ty*pt=n->as.tg->se.p->ty?tcc(n->as.tg->se.p->ty):0;V p={nt(g),VK_P};if(n->as.tg->se.p->k==N_ID){Sy*s=n->as.tg->se.p->sy?n->as.tg->se.p->sy:syf(g->sm,n->as.tg->se.p->s);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  %%t%d = bitcast ptr %%lnk.%d.%.*s to ptr\n",p.id,s->lv,(int)n->as.tg->se.p->s.n,n->as.tg->se.p->s.s);else fprintf(g->o,"  %%t%d = bitcast ptr %%v.%s.sc%u.%u to ptr\n",p.id,LC(n->as.tg->se.p->s),s?s->sc:0,s?s->el:0);}else{p=gex(g,n->as.tg->se.p);}if(pt&&pt->k==TY_R){if(pt->pk){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->as.tg->se.se)){v=vcast(g,v,VK_I);int bp=nt(g);fprintf(g->o,"  %%t%d = ptrtoint ptr %%t%d to i64\n",bp,p.id);int bo=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, %u\n",bo,bp,c->cm.of/8);int pp=nt(g);fprintf(g->o,"  %%t%d = inttoptr i64 %%t%d to ptr\n",pp,bo);int ov=nt(g);fprintf(g->o,"  %%t%d = load i64, ptr %%t%d\n",ov,pp);uint64_t mk=(1ULL<<c->cm.bt)-1;int sh=nt(g);fprintf(g->o,"  %%t%d = shl i64 %%t%d, %u\n",sh,v.id,c->cm.of%8);int ms=nt(g);fprintf(g->o,"  %%t%d = and i64 %%t%d, %llu\n",ms,sh,(unsigned long long)(mk<<(c->cm.of%8)));uint64_t cmk=~(mk<<(c->cm.of%8));int cl=nt(g);fprintf(g->o,"  %%t%d = and i64 %%t%d, %llu\n",cl,ov,(unsigned long long)cmk);int nv_=nt(g);fprintf(g->o,"  %%t%d = or i64 %%t%d, %%t%d\n",nv_,cl,ms);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",nv_,pp);break;}}}else{for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->as.tg->se.se)){int ep=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%t%d, i64 %u\n",ep,p.id,c->cm.of);v=vcast(g,v,VK_I);fprintf(g->o,"  store i64 %%t%d, ptr %%t%d\n",v.id,ep);break;}}}}}else{v=vcast(g,v,VK_I);fprintf(g->o,"  ; store to complex lvalue\n");}}break;case N_IF:{V c=vbool(g,gex(g,n->if_.cd));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int lt=nl(g),lf=nl(g),ld=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,lt,lf);fprintf(g->o,"L%d:\n",lt);for(uint32_t i=0;i<n->if_.th.n;i++)gss(g,n->if_.th.d[i]);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lf);if(n->if_.ei.n>0){for(uint32_t i=0;i<n->if_.ei.n;i++){No*e=n->if_.ei.d[i];V ec=vbool(g,gex(g,e->if_.cd));int ect=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ect,ec.id);int let=nl(g),lef=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ect,let,lef);fprintf(g->o,"L%d:\n",let);for(uint32_t j=0;j<e->if_.th.n;j++)gss(g,e->if_.th.d[j]);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lef);}}if(n->if_.el.n>0){for(uint32_t i=0;i<n->if_.el.n;i++)gss(g,n->if_.el.d[i]);}fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",ld);}break;case N_CS:{V ex=gex(g,n->cs.ex);int ld=nl(g);NV lb={0};for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=nl(g);nv(&lb,ND(INT,n->l));lb.d[i]->i=la;}for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=lb.d[i]->i;for(uint32_t j=0;j<a->ch.it.n;j++){No*ch=a->ch.it.d[j];if(ch->k==N_ID&&si(ch->s,Z("others"))){fprintf(g->o,"  br label %%L%d\n",la);goto cs_sw_done;}V cv=gex(g,ch);cv=vcast(g,cv,ex.k);if(ch->k==N_RN){V lo=gex(g,ch->rn.lo);lo=vcast(g,lo,ex.k);V hi=gex(g,ch->rn.hi);hi=vcast(g,hi,ex.k);int cge=nt(g);fprintf(g->o,"  %%t%d = icmp sge i64 %%t%d, %%t%d\n",cge,ex.id,lo.id);int cle=nt(g);fprintf(g->o,"  %%t%d = icmp sle i64 %%t%d, %%t%d\n",cle,ex.id,hi.id);int ca=nt(g);fprintf(g->o,"  %%t%d = and i1 %%t%d, %%t%d\n",ca,cge,cle);int lnx=i+1<n->cs.al.n?lb.d[i+1]->i:ld;fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ca,la,lnx);}else{int ceq=nt(g);fprintf(g->o,"  %%t%d = icmp eq i64 %%t%d, %%t%d\n",ceq,ex.id,cv.id);int lnx=i+1<n->cs.al.n?lb.d[i+1]->i:ld;fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ceq,la,lnx);}}}cs_sw_done:;for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];int la=lb.d[i]->i;fprintf(g->o,"L%d:\n",la);for(uint32_t j=0;j<a->hnd.stz.n;j++)gss(g,a->hnd.stz.d[j]);fprintf(g->o,"  br label %%L%d\n",ld);}fprintf(g->o,"L%d:\n",ld);}break;case N_LP:{int lb=nl(g),lc=nl(g),le=nl(g);if(g->ls<64)g->ll[g->ls++]=le;if(n->lp.lb.s){slv(&g->lbs,n->lp.lb);nv(&n->lp.lk,ND(INT,n->l));n->lp.lk.d[n->lp.lk.n-1]->i=le;}No*fv=0;Ty*ft=0;if(n->lp.it&&n->lp.it->k==N_BIN&&n->lp.it->bn.op==T_IN&&n->lp.it->bn.l->k==N_ID){fv=n->lp.it->bn.l;ft=n->lp.it->bn.r->ty?tcc(n->lp.it->bn.r->ty):0;if(ft){Sy*vs=syf(g->sm,fv->s);if(vs){int ti=nt(g);fprintf(g->o,"  %%t%d = add i64 0, %lld\n",ti,(long long)ft->lo);if(vs->lv==0){char nb[256];if(vs->pr&&vs->pr->nm.s){int n=0;for(uint32_t i=0;i<vs->pr->nm.n;i++)nb[n++]=toupper(vs->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<vs->nm.n;i++)nb[n++]=toupper(vs->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)vs->nm.n,vs->nm.s);fprintf(g->o,"  store i64 %%t%d, ptr @%s\n",ti,nb);}else fprintf(g->o,"  store i64 %%t%d, ptr %%v.%s.sc%u.%u\n",ti,LC(fv->s),vs->sc,vs->el);}}}fprintf(g->o,"  br label %%L%d\n",lb);fprintf(g->o,"L%d:\n",lb);if(n->lp.it){V c=vbool(g,gex(g,n->lp.it));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,lc,le);}else fprintf(g->o,"  br label %%L%d\n",lc);fprintf(g->o,"L%d:\n",lc);for(uint32_t i=0;i<n->lp.st.n;i++)gss(g,n->lp.st.d[i]);if(fv&&ft){Sy*vs=syf(g->sm,fv->s);if(vs){int cv=nt(g);if(vs->lv==0){char nb[256];if(vs->pr&&vs->pr->nm.s){int n=0;for(uint32_t i=0;i<vs->pr->nm.n;i++)nb[n++]=toupper(vs->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<vs->nm.n;i++)nb[n++]=toupper(vs->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)vs->nm.n,vs->nm.s);fprintf(g->o,"  %%t%d = load i64, ptr @%s\n",cv,nb);int nv=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, 1\n",nv,cv);fprintf(g->o,"  store i64 %%t%d, ptr @%s\n",nv,nb);}else{fprintf(g->o,"  %%t%d = load i64, ptr %%v.%s.sc%u.%u\n",cv,LC(fv->s),vs->sc,vs->el);int nv=nt(g);fprintf(g->o,"  %%t%d = add i64 %%t%d, 1\n",nv,cv);fprintf(g->o,"  store i64 %%t%d, ptr %%v.%s.sc%u.%u\n",nv,LC(fv->s),vs->sc,vs->el);}}}fprintf(g->o,"  br label %%L%d\n",lb);fprintf(g->o,"L%d:\n",le);if(g->ls>0)g->ls--;}break;case N_EX:{if(n->ex.lb.s){int li=flbl(g,n->ex.lb);if(li>=0){int le=g->ll[li];if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int lc=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,le,lc);fprintf(g->o,"L%d:\n",lc);}else fprintf(g->o,"  br label %%L%d\n",le);}else{if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int le=g->ls>0?g->ll[g->ls-1]:nl(g),lc=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,le,lc);fprintf(g->o,"L%d:\n",lc);}else{int le=g->ls>0?g->ll[g->ls-1]:nl(g);fprintf(g->o,"  br label %%L%d\n",le);}}}else{if(n->ex.cd){V c=vbool(g,gex(g,n->ex.cd));int ct=nt(g);fprintf(g->o,"  %%t%d = icmp ne i64 %%t%d, 0\n",ct,c.id);int le=g->ls>0?g->ll[g->ls-1]:nl(g),lc=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ct,le,lc);fprintf(g->o,"L%d:\n",lc);}else{int le=g->ls>0?g->ll[g->ls-1]:nl(g);fprintf(g->o,"  br label %%L%d\n",le);}}}break;case N_GT:{int li=flbl(g,n->go.lb);if(li>=0){fprintf(g->o,"  br label %%lbl.%.*s\n",(int)n->go.lb.n,n->go.lb.s);}else fprintf(g->o,"  br label %%lbl.%.*s\n",(int)n->go.lb.n,n->go.lb.s);}break;case N_RT:{if(n->rt.vl){V v=gex(g,n->rt.vl);fprintf(g->o,"  ret %s %%t%d\n",vt(v.k),v.id);}else fprintf(g->o,"  ret void\n");}break;case N_RS:{S ec=n->rs.ec&&n->rs.ec->k==N_ID?n->rs.ec->s:Z("PROGRAM_ERROR");eex(g,ec);int exh=nt(g);fprintf(g->o,"  %%t%d = load ptr, ptr %%ej\n",exh);fprintf(g->o,"  store ptr @.ex.%.*s, ptr @__ex_cur\n",(int)ec.n,ec.s);fprintf(g->o,"  call void @longjmp(ptr %%t%d, i32 1)\n",exh);fprintf(g->o,"  unreachable\n");}break;case N_CLT:{if(n->ct.nm->k==N_ID){Sy*s=syfa(g->sm,n->ct.nm->s,n->ct.arr.n,0);
if(s){if(si(s->nm,Z("PUT"))||si(s->nm,Z("PUT_LINE"))){if(n->ct.arr.n>0){V v=gex(g,n->ct.arr.d[0]);if(v.k==VK_I)fprintf(g->o,"  call void @__text_io_put_i64(i64 %%t%d)\n",v.id);else if(v.k==VK_F)fprintf(g->o,"  call void @__text_io_put_f64(double %%t%d)\n",v.id);else fprintf(g->o,"  call void @__text_io_put_str(ptr %%t%d)\n",v.id);if(si(s->nm,Z("PUT_LINE")))fprintf(g->o,"  call void @__text_io_newline()\n");}break;}if(si(s->nm,Z("NEW_LINE"))){fprintf(g->o,"  call void @__text_io_newline()\n");break;}No*b=sbody(s,s->el);if(b){int arid[64];Vk ark[64];int arp[64];No*sp=b->bd.sp;for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){No*pm=sp&&i<sp->sp.pmm.n?sp->sp.pmm.d[i]:0;V av=gex(g,n->ct.arr.d[i]);Vk ek=VK_I;bool rf=false;if(pm&&pm->sy&&pm->sy->ty){ek=tk2v(pm->sy->ty);if(pm->pm.md&2){rf=true;int ap=nt(g);fprintf(g->o,"  %%t%d = alloca %s\n",ap,vt(ek));fprintf(g->o,"  store %s %%t%d, ptr %%t%d\n",vt(ek),av.id,ap);av.id=ap;av.k=VK_P;ek=VK_P;}}if(!rf){V cv=vcast(g,av,ek);av=cv;}arid[i]=av.id;ark[i]=ek;arp[i]=rf?1:0;}char nb[256];esn(nb,256,s,n->ct.nm->s);fprintf(g->o,"  call void @\"%s\"(",nb);for(uint32_t i=0;i<n->ct.arr.n;i++){if(i)fprintf(g->o,", ");fprintf(g->o,"%s %%t%d",vt(ark[i]),arid[i]);}if(s->lv>0){if(n->ct.arr.n>0)fprintf(g->o,", ");fprintf(g->o,"ptr %%__frame");}fprintf(g->o,")\n");for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){if(arp[i]){int lv=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%t%d\n",lv,vt(ark[i]==VK_P?VK_I:ark[i]),arid[i]);V rv={lv,ark[i]==VK_P?VK_I:ark[i]};V cv=vcast(g,rv,tk2v(n->ct.arr.d[i]->ty));No*tg=n->ct.arr.d[i];if(tg->k==N_ID){Sy*ts=tg->sy?tg->sy:syf(g->sm,tg->s);if(ts){if(ts->lv>=0&&ts->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(cv.k),cv.id,ts->lv,LC(tg->s));else fprintf(g->o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(cv.k),cv.id,LC(tg->s),ts->sc,ts->el);}}}}}else if(s->k==4||s->k==5){No*sp=s->ol.n>0&&(s->ol.d[0]->k==N_PD||s->ol.d[0]->k==N_FD)?s->ol.d[0]->bd.sp:0;int arid[64];Vk ark[64];for(uint32_t i=0;i<n->ct.arr.n&&i<64;i++){No*pm=sp&&i<sp->sp.pmm.n?sp->sp.pmm.d[i]:0;V av=gex(g,n->ct.arr.d[i]);Vk ek=VK_I;if(pm&&pm->pm.ty){Ty*pt=rst(g->sm,pm->pm.ty);ek=tk2v(pt);}V cv=vcast(g,av,ek);arid[i]=cv.id;ark[i]=ek;}char nb[256];esn(nb,256,s,n->ct.nm->s);if(s->k==5&&sp&&sp->sp.rt){Ty*rt=rst(g->sm,sp->sp.rt);Vk rk=tk2v(rt);int rid=nt(g);fprintf(g->o,"  %%t%d = call %s @\"%s\"(",rid,vt(rk),nb);}else fprintf(g->o,"  call void @\"%s\"(",nb);for(uint32_t i=0;i<n->ct.arr.n;i++){if(i)fprintf(g->o,", ");fprintf(g->o,"%s %%t%d",vt(ark[i]),arid[i]);}fprintf(g->o,")\n");}}}break;case N_BL:{int sj=nt(g);fprintf(g->o,"  %%t%d = call ptr @__ada_setjmp()\n",sj);fprintf(g->o,"  store ptr %%t%d, ptr %%ej\n",sj);fprintf(g->o,"  store ptr %%t%d, ptr @__eh_cur\n",sj);int sv=nt(g);fprintf(g->o,"  %%t%d = call i32 @setjmp(ptr %%t%d)\n",sv,sj);int ze=nt(g);fprintf(g->o,"  %%t%d = icmp eq i32 %%t%d, 0\n",ze,sv);int ln=nl(g),lh=nl(g);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",ze,ln,lh);fprintf(g->o,"L%d:\n",ln);for(uint32_t i=0;i<n->bk.dc.n;i++){No*d=n->bk.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB&&!((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext))gdl(g,d);}for(uint32_t i=0;i<n->bk.st.n;i++)gss(g,n->bk.st.d[i]);int ld=nl(g);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lh);if(n->bk.hd.n>0){for(uint32_t i=0;i<n->bk.hd.n;i++){No*h=n->bk.hd.d[i];int lhm=nl(g),lhn=nl(g);for(uint32_t j=0;j<h->hnd.ec.n;j++){No*e=h->hnd.ec.d[j];if(e->k==N_ID&&si(e->s,Z("others"))){fprintf(g->o,"  br label %%L%d\n",lhm);break;}int ec=nt(g);fprintf(g->o,"  %%t%d = load ptr, ptr @__ex_cur\n",ec);int cm=nt(g);fprintf(g->o,"  %%t%d = call i32 @strcmp(ptr %%t%d, ptr @.ex.%.*s)\n",cm,ec,(int)e->s.n,e->s.s);int eq=nt(g);fprintf(g->o,"  %%t%d = icmp eq i32 %%t%d, 0\n",eq,cm);fprintf(g->o,"  br i1 %%t%d, label %%L%d, label %%L%d\n",eq,lhm,lhn);fprintf(g->o,"L%d:\n",lhn);}fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",lhm);for(uint32_t j=0;j<h->hnd.stz.n;j++)gss(g,h->hnd.stz.d[j]);fprintf(g->o,"  br label %%L%d\n",ld);}}else{int exc=nt(g);fprintf(g->o,"  %%t%d = load ptr, ptr @__ex_cur\n",exc);fprintf(g->o,"  call void @__ada_raise(ptr %%t%d)\n  unreachable\n",exc);}fprintf(g->o,"L%d:\n",ld);}break;case N_DL:{V d=gex(g,n->ex.cd);d=vcast(g,d,VK_I);fprintf(g->o,"  call void @__ada_delay(i64 %%t%d)\n",d.id);}break;case N_SA:{if(n->sa.kn==1||n->sa.kn==3){V gd=gex(g,n->sa.gd);int ld=nl(g);fprintf(g->o,"  call void @__ada_delay(i64 %%t%d)\n",gd.id);if(n->sa.kn==3)fprintf(g->o,"  call void @__ada_raise(ptr @.ex.TASKING_ERROR)\n  unreachable\n");for(uint32_t i=0;i<n->sa.sts.n;i++)gss(g,n->sa.sts.d[i]);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",ld);}else{int ld=nl(g);for(uint32_t i=0;i<n->sa.sts.n;i++){No*st=n->sa.sts.d[i];if(st->k==N_ACC){for(uint32_t j=0;j<st->acc.stx.n;j++)gss(g,st->acc.stx.d[j]);}else if(st->k==N_DL){V d=gex(g,st->ex.cd);fprintf(g->o,"  call void @__ada_delay(i64 %%t%d)\n",d.id);for(uint32_t j=0;j<st->hnd.stz.n;j++)gss(g,st->hnd.stz.d[j]);}}if(n->ss.el.n>0)for(uint32_t i=0;i<n->ss.el.n;i++)gss(g,n->ss.el.d[i]);fprintf(g->o,"  br label %%L%d\n",ld);fprintf(g->o,"L%d:\n",ld);}}break;default:break;}}}
static void gdl(Gn*g,No*n){if(!n)return;switch(n->k){case N_OD:break;case N_PD:{No*sp=n->bd.sp;char nb[256];if(n->sy&&n->sy->ext)snprintf(nb,256,"%.*s",(int)n->sy->ext_nm.n,n->sy->ext_nm.s);else esn(nb,256,n->sy,sp->sp.nm);fprintf(g->o,"declare void @\"%s\"(",nb);for(uint32_t i=0;i<sp->sp.pmm.n;i++){if(i)fprintf(g->o,",");No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;if(p->pm.md&2)fprintf(g->o,"ptr");else fprintf(g->o,"%s",vt(k));}fprintf(g->o,")\n");}break;case N_FD:{No*sp=n->bd.sp;char nb[256];if(n->sy&&n->sy->ext)snprintf(nb,256,"%.*s",(int)n->sy->ext_nm.n,n->sy->ext_nm.s);else esn(nb,256,n->sy,sp->sp.nm);Vk rk=sp->sp.rt?tk2v(rst(g->sm,sp->sp.rt)):VK_I;fprintf(g->o,"declare %s @\"%s\"(",vt(rk),nb);for(uint32_t i=0;i<sp->sp.pmm.n;i++){if(i)fprintf(g->o,",");No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;if(p->pm.md&2)fprintf(g->o,"ptr");else fprintf(g->o,"%s",vt(k));}fprintf(g->o,")\n");}break;case N_BL:for(uint32_t i=0;i<n->bk.dc.n;i++){No*d=n->bk.dc.d[i];if(d&&(d->k==N_PB||d->k==N_FB))gdl(g,d);}for(uint32_t i=0;i<n->bk.st.n;i++){if(n->bk.st.d[i]->k==N_BL)gdl(g,n->bk.st.d[i]);}break;case N_PB:{for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k==N_PKB)gdl(g,d);}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&(d->k==N_PB||d->k==N_FB||((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext)))gdl(g,d);}for(uint32_t i=0;i<n->bd.st.n;i++){if(n->bd.st.d[i]->k==N_BL)gdl(g,n->bd.st.d[i]);}No*sp=n->bd.sp;char nb[256];esn(nb,256,n->sy,sp->sp.nm);fprintf(g->o,"define void @\"%s\"(",nb);int np=sp->sp.pmm.n;if(n->sy&&n->sy->lv>0)np++;for(int i=0;i<np;i++){if(i)fprintf(g->o,", ");if(i<(int)sp->sp.pmm.n){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;if(p->pm.md&2)fprintf(g->o,"ptr %%p.%s",LC(p->pm.nm));else fprintf(g->o,"%s %%p.%s",vt(k),LC(p->pm.nm));}else fprintf(g->o,"ptr %%__slnk");}fprintf(g->o,") {\n");fprintf(g->o,"  %%ej = alloca ptr\n");int sv=g->sm->lv;g->sm->lv=n->sy?n->sy->lv+1:0;gbf(g);for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;Sy*ps=p->sy;if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  %%lnk.%d.%s = alloca %s\n",ps->lv,LC(p->pm.nm),vt(k));else fprintf(g->o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0,vt(k));if(p->pm.md&2){int lv=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%p.%s\n",lv,vt(k),LC(p->pm.nm));if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),lv,ps->lv,LC(p->pm.nm));else fprintf(g->o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),lv,LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0);}else{if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  store %s %%p.%s, ptr %%lnk.%d.%s\n",vt(k),LC(p->pm.nm),ps->lv,LC(p->pm.nm));else fprintf(g->o,"  store %s %%p.%s, ptr %%v.%s.sc%u.%u\n",vt(k),LC(p->pm.nm),LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0);}}if(n->sy&&n->sy->lv>0){for(int h=0;h<4096;h++){for(Sy*s=g->sm->sy[h];s;s=s->nx){if(s->k==0&&s->lv>=0&&s->lv<g->sm->lv){Vk k=s->ty?tk2v(s->ty):VK_I;Ty*at=s->ty?tcc(s->ty):0;if(at&&at->k==TY_A&&at->hi>=at->lo){int asz=(int)(at->hi-at->lo+1);fprintf(g->o,"  %%v.%s.sc%u.%u = alloca [%d x i64]\n",LC(s->nm),s->sc,s->el,asz);}else{fprintf(g->o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(s->nm),s->sc,s->el,vt(k));}int p=nt(g);fprintf(g->o,"  %%t%d = getelementptr i64, ptr %%__slnk, i64 %u\n",p,s->el);int v=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%t%d\n",v,vt(k),p);fprintf(g->o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v,LC(s->nm),s->sc,s->el);}}}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB&&!((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext))gdl(g,d);}for(int h=0;h<4096;h++){for(Sy*s=g->sm->sy[h];s;s=s->nx){if(s->k==0&&(s->lv==-1||s->lv>=g->sm->lv)&&s->el>=0){bool is_pm=false;for(uint32_t pi=0;pi<sp->sp.pmm.n;pi++){if(sp->sp.pmm.d[pi]->sy==s){is_pm=true;break;}}if(!is_pm){Vk k=s->ty?tk2v(s->ty):VK_I;Ty*at=s->ty?tcc(s->ty):0;if(at&&at->k==TY_A&&at->hi>=at->lo){int asz=(int)(at->hi-at->lo+1);fprintf(g->o,"  %%v.%s.sc%u.%u = alloca [%d x i64]\n",LC(s->nm),s->sc,s->el,asz);}else{fprintf(g->o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(s->nm),s->sc,s->el,vt(k));}int fp=nt(g);int mx=g->sm->eo;fprintf(g->o,"  %%t%d = getelementptr [%d x ptr], ptr %%__frame, i64 0, i64 %u\n",fp,mx,s->el);fprintf(g->o,"  store ptr %%v.%s.sc%u.%u, ptr %%t%d\n",LC(s->nm),s->sc,s->el,fp);}}}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k==N_OD&&d->od.in){for(uint32_t j=0;j<d->od.id.n;j++){No*id=d->od.id.d[j];if(!id->sy||id->sy->k!=2){Vk k=d->od.ty?tk2v(rst(g->sm,d->od.ty)):VK_I;Sy*s=id->sy;V v=gex(g,d->od.in);v=vcast(g,v,k);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),v.id,s->lv,LC(id->s));else fprintf(g->o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v.id,LC(id->s),s?s->sc:0,s?s->el:0);}}}}for(uint32_t i=0;i<n->bd.st.n;i++)gss(g,n->bd.st.d[i]);g->sm->lv=sv;fprintf(g->o,"  ret void\n}\n");}break;case N_FB:{for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k==N_PKB)gdl(g,d);}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&(d->k==N_PB||d->k==N_FB||((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext)))gdl(g,d);}for(uint32_t i=0;i<n->bd.st.n;i++){if(n->bd.st.d[i]->k==N_BL)gdl(g,n->bd.st.d[i]);}No*sp=n->bd.sp;Vk rk=sp->sp.rt?tk2v(rst(g->sm,sp->sp.rt)):VK_I;char nb[256];esn(nb,256,n->sy,sp->sp.nm);fprintf(g->o,"define %s @\"%s\"(",vt(rk),nb);int np=sp->sp.pmm.n;if(n->sy&&n->sy->lv>0)np++;for(int i=0;i<np;i++){if(i)fprintf(g->o,", ");if(i<(int)sp->sp.pmm.n){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;if(p->pm.md&2)fprintf(g->o,"ptr %%p.%s",LC(p->pm.nm));else fprintf(g->o,"%s %%p.%s",vt(k),LC(p->pm.nm));}else fprintf(g->o,"ptr %%__slnk");}fprintf(g->o,") {\n");fprintf(g->o,"  %%ej = alloca ptr\n");int sv=g->sm->lv;g->sm->lv=n->sy?n->sy->lv+1:0;gbf(g);for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(g->sm,p->pm.ty)):VK_I;Sy*ps=p->sy;if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  %%lnk.%d.%s = alloca %s\n",ps->lv,LC(p->pm.nm),vt(k));else fprintf(g->o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0,vt(k));if(p->pm.md&2){int lv=nt(g);fprintf(g->o,"  %%t%d = load %s, ptr %%p.%s\n",lv,vt(k),LC(p->pm.nm));if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),lv,ps->lv,LC(p->pm.nm));else fprintf(g->o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),lv,LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0);}else{if(ps&&ps->lv>=0&&ps->lv<g->sm->lv)fprintf(g->o,"  store %s %%p.%s, ptr %%lnk.%d.%s\n",vt(k),LC(p->pm.nm),ps->lv,LC(p->pm.nm));else fprintf(g->o,"  store %s %%p.%s, ptr %%v.%s.sc%u.%u\n",vt(k),LC(p->pm.nm),LC(p->pm.nm),ps?ps->sc:0,ps?ps->el:0);}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k!=N_PB&&d->k!=N_FB&&!((d->k==N_PD||d->k==N_FD)&&d->sy&&d->sy->ext))gdl(g,d);}for(int h=0;h<4096;h++){for(Sy*s=g->sm->sy[h];s;s=s->nx){if(s->k==0&&(s->lv==-1||s->lv>=g->sm->lv)&&s->el>=0){bool is_pm=false;for(uint32_t pi=0;pi<sp->sp.pmm.n;pi++){if(sp->sp.pmm.d[pi]->sy==s){is_pm=true;break;}}if(!is_pm){Vk k=s->ty?tk2v(s->ty):VK_I;fprintf(g->o,"  %%v.%s.sc%u.%u = alloca %s\n",LC(s->nm),s->sc,s->el,vt(k));int fp=nt(g);int mx=g->sm->eo;fprintf(g->o,"  %%t%d = getelementptr [%d x ptr], ptr %%__frame, i64 0, i64 %u\n",fp,mx,s->el);fprintf(g->o,"  store ptr %%v.%s.sc%u.%u, ptr %%t%d\n",LC(s->nm),s->sc,s->el,fp);}}}}for(uint32_t i=0;i<n->bd.dc.n;i++){No*d=n->bd.dc.d[i];if(d&&d->k==N_OD&&d->od.in){for(uint32_t j=0;j<d->od.id.n;j++){No*id=d->od.id.d[j];if(!id->sy||id->sy->k!=2){Vk k=d->od.ty?tk2v(rst(g->sm,d->od.ty)):VK_I;Sy*s=id->sy;V v=gex(g,d->od.in);v=vcast(g,v,k);if(s&&s->lv>=0&&s->lv<g->sm->lv)fprintf(g->o,"  store %s %%t%d, ptr %%lnk.%d.%s\n",vt(k),v.id,s->lv,LC(id->s));else fprintf(g->o,"  store %s %%t%d, ptr %%v.%s.sc%u.%u\n",vt(k),v.id,LC(id->s),s?s->sc:0,s?s->el:0);}}}}for(uint32_t i=0;i<n->bd.st.n;i++)gss(g,n->bd.st.d[i]);if(rk==VK_P)fprintf(g->o,"  ret ptr null\n}\n");else fprintf(g->o,"  ret %s 0\n}\n",vt(rk));}break;case N_PKB:for(uint32_t i=0;i<n->pb.st.n;i++){if(n->pb.st.d[i]->k==N_BL)gdl(g,n->pb.st.d[i]);}break;default:break;}}
static void gel(Gn*g,No*n){if(n&&n->k==N_PKB&&n->pb.st.n>0){char nb[256];snprintf(nb,256,"%.*s__elab",(int)n->pb.nm.n,n->pb.nm.s);fprintf(g->o,"define void @\"%s\"() {\n",nb);for(uint32_t i=0;i<n->pb.st.n;i++)gss(g,n->pb.st.d[i]);fprintf(g->o,"  ret void\n}\n");fprintf(g->o,"@llvm.global_ctors=appending global[1 x {i32,ptr,ptr}][{i32,ptr,ptr}{i32 65535,ptr @\"%s\",ptr null}]\n",nb);}}
static void grt(Gn*g){fprintf(g->o,"declare i32 @setjmp(ptr)\ndeclare void @longjmp(ptr,i32)\ndeclare i32 @pthread_create(ptr,ptr,ptr,ptr)\ndeclare i32 @pthread_join(i64,ptr)\ndeclare i32 @pthread_mutex_init(ptr,ptr)\ndeclare i32 @pthread_mutex_lock(ptr)\ndeclare i32 @pthread_mutex_unlock(ptr)\ndeclare i32 @usleep(i32)\ndeclare ptr @malloc(i64)\ndeclare void @free(ptr)\ndeclare i32 @printf(ptr,...)\ndeclare i32 @puts(ptr)\ndeclare i32 @sprintf(ptr,ptr,...)\ndeclare i32 @strcmp(ptr,ptr)\ndeclare i64 @strlen(ptr)\ndeclare double @pow(double,double)\ndeclare void @llvm.memcpy.p0.p0.i64(ptr,ptr,i64,i1)\n");fprintf(g->o,"@stdin=external global ptr\n@stdout=external global ptr\n@stderr=external global ptr\n");fprintf(g->o,"@__eh_cur=linkonce_odr global ptr null\n@__ex_cur=linkonce_odr global ptr null\n");fprintf(g->o,"@.ex.CONSTRAINT_ERROR=linkonce_odr constant[17 x i8]c\"CONSTRAINT_ERROR\\00\"\n@.ex.PROGRAM_ERROR=linkonce_odr constant[14 x i8]c\"PROGRAM_ERROR\\00\"\n@.ex.STORAGE_ERROR=linkonce_odr constant[14 x i8]c\"STORAGE_ERROR\\00\"\n@.ex.TASKING_ERROR=linkonce_odr constant[14 x i8]c\"TASKING_ERROR\\00\"\n@.ex.USE_ERROR=linkonce_odr constant[10 x i8]c\"USE_ERROR\\00\"\n@.ex.NAME_ERROR=linkonce_odr constant[11 x i8]c\"NAME_ERROR\\00\"\n@.ex.STATUS_ERROR=linkonce_odr constant[13 x i8]c\"STATUS_ERROR\\00\"\n@.ex.MODE_ERROR=linkonce_odr constant[11 x i8]c\"MODE_ERROR\\00\"\n@.ex.END_ERROR=linkonce_odr constant[10 x i8]c\"END_ERROR\\00\"\n@.ex.DATA_ERROR=linkonce_odr constant[11 x i8]c\"DATA_ERROR\\00\"\n@.ex.DEVICE_ERROR=linkonce_odr constant[13 x i8]c\"DEVICE_ERROR\\00\"\n@.ex.LAYOUT_ERROR=linkonce_odr constant[13 x i8]c\"LAYOUT_ERROR\\00\"\n");fprintf(g->o,"define linkonce_odr ptr @__ada_setjmp(){%%p=call ptr @malloc(i64 200)ret ptr %%p}\n");fprintf(g->o,"define linkonce_odr void @__ada_raise(ptr %%msg){store ptr %%msg,ptr @__ex_cur call void @longjmp(ptr @__eh_cur,i32 1)ret void}\n");fprintf(g->o,"define linkonce_odr void @__ada_delay(i64 %%us){%%t=trunc i64 %%us to i32 call i32 @usleep(i32 %%t)ret void}\n");fprintf(g->o,"define linkonce_odr i64 @__ada_powi(i64 %%a,i64 %%b){%%c=icmp slt i64 %%b,0 br i1 %%c,label %%e,label %%s\ns:%%p=phi i64[1,%%0],[%%p2,%%l]%%x=phi i64[%%a,%%0],[%%n,%%l]%%i=phi i64[%%b,%%0],[%%j,%%l]%%t=and i64 %%i,1 %%z=icmp eq i64 %%t,0 br i1 %%z,label %%k,label %%m\nm:%%r=mul i64 %%p,%%x br label %%k\nk:%%p2=phi i64[%%p,%%s],[%%r,%%m]%%j=lshr i64 %%i,1 %%n=mul i64 %%x,%%x %%d=icmp eq i64 %%j,0 br i1 %%d,label %%o,label %%l\nl:br label %%s\no:ret i64 %%p2\ne:ret i64 0}\n");fprintf(g->o,"@.fmt_i64=linkonce_odr constant[5 x i8]c\"%%lld\\00\"\n@.fmt_f64=linkonce_odr constant[3 x i8]c\"%%g\\00\"\n");fprintf(g->o,"define linkonce_odr void @__text_io_put_i64(i64 %%v){%%s=alloca[32 x i8]%%p=getelementptr[32 x i8],ptr %%s,i64 0,i64 0 call i32(ptr,ptr,...)@sprintf(ptr %%p,ptr @.fmt_i64,i64 %%v)call i32 @puts(ptr %%p)ret void}\n");fprintf(g->o,"define linkonce_odr void @__text_io_put_f64(double %%v){%%s=alloca[32 x i8]%%p=getelementptr[32 x i8],ptr %%s,i64 0,i64 0 call i32(ptr,ptr,...)@sprintf(ptr %%p,ptr @.fmt_f64,double %%v)call i32 @puts(ptr %%p)ret void}\n");fprintf(g->o,"define linkonce_odr void @__text_io_put_str(ptr %%s){call i32 @puts(ptr %%s)ret void}\n");fprintf(g->o,"define linkonce_odr void @__text_io_newline(){%%nl=alloca[2 x i8]store[2 x i8]c\"\\0A\\00\",ptr %%nl call i32 @puts(ptr %%nl)ret void}\n");fprintf(g->o,"define linkonce_odr ptr @__ada_image_int(i64 %%v){%%s=call ptr @malloc(i64 32)call i32(ptr,ptr,...)@sprintf(ptr %%s,ptr @.fmt_i64,i64 %%v)ret ptr %%s}\n");fprintf(g->o,"define linkonce_odr ptr @__ada_image_enum(i64 %%p,i64 %%lo,i64 %%hi){%%s=call ptr @malloc(i64 32)call i32(ptr,ptr,...)@sprintf(ptr %%s,ptr @.fmt_i64,i64 %%p)ret ptr %%s}\n");fprintf(g->o,"define linkonce_odr i64 @__ada_value_int(ptr %%s){ret i64 0}\n");}
static char*rf(const char*p){FILE*f=fopen(p,"rb");if(!f)return 0;fseek(f,0,SEEK_END);long z=ftell(f);fseek(f,0,SEEK_SET);char*b=malloc(z+1);size_t _=fread(b,1,z,f);(void)_;b[z]=0;fclose(f);return b;}
static void wf(const char*p,const char*d){FILE*f=fopen(p,"wb");if(!f)return;fputs(d,f);fclose(f);}
static void wali(Sm*SM,const char*fn,No*cu){if(!cu||cu->cu.un.n==0)return;char alp[520];snprintf(alp,520,"%s.ali",fn);FILE*f=fopen(alp,"w");if(!f)return;fprintf(f,"V 1.0\n");No*u0=cu->cu.un.d[0];S nm=u0->k==N_PKS?u0->ps.nm:u0->k==N_PKB?u0->pb.nm:N;fprintf(f,"U %.*s\n",(int)nm.n,nm.s);for(int h=0;h<4096;h++){for(Sy*s=SM->sy[h];s;s=s->nx){if((s->k==4||s->k==5)&&s->pr&&si(s->pr->nm,nm)){char nb[256];esn(nb,256,s,s->nm);fprintf(f,"X %s",nb);if(s->k==4){fprintf(f," void");No*sp=s->ol.n>0&&s->ol.d[0]->bd.sp?s->ol.d[0]->bd.sp:0;if(sp)for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(SM,p->pm.ty)):VK_I;fprintf(f," %s",vt(k));}}else{No*sp=s->ol.n>0&&s->ol.d[0]->bd.sp?s->ol.d[0]->bd.sp:0;Ty*rt=sp&&sp->sp.rt?rst(SM,sp->sp.rt):0;Vk rk=tk2v(rt);fprintf(f," %s",vt(rk));if(sp)for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Vk k=p->pm.ty?tk2v(rst(SM,p->pm.ty)):VK_I;fprintf(f," %s",vt(k));}}fprintf(f,"\n");}}}fclose(f);}
static LU*lfnd(Sm*SM,S nm){for(uint32_t i=0;i<SM->lu.n;i++){LU*l=SM->lu.d[i];if(si(l->nm,nm))return l;}return 0;}
static uint64_t fts(const char*p){struct stat s;if(stat(p,&s))return 0;return s.st_mtime;}
static bool lcmp(Sm*SM,S nm,S pth){LU*ex=lfnd(SM,nm);if(ex&&ex->cmpl)return true;char fp[512];snprintf(fp,512,"%.*s.adb",(int)pth.n,pth.s);char*src=rf(fp);if(!src){snprintf(fp,512,"%.*s.ads",(int)pth.n,pth.s);src=rf(fp);}if(!src)return false;Ps p=pnw(src,strlen(src),fp);No*cu=pcu(&p);if(!cu)return false;Sm sm;smi(&sm);sm.lu=SM->lu;sm.gt=SM->gt;smu(&sm,cu);char op[512];snprintf(op,512,"%.*s.ll",(int)pth.n,pth.s);FILE*o=fopen(op,"w");Gn g={o,0,0,&sm,{0},0,{0},0,{0},0,{0},0,{0},{0}};grt(&g);for(uint32_t i=0;i<sm.eo;i++){for(uint32_t j=0;j<4096;j++){for(Sy*s=sm.sy[j];s;s=s->nx){if(s->el==i){for(uint32_t k=0;k<s->ol.n;k++)gdl(&g,s->ol.d[k]);}}}}for(uint32_t ui=0;ui<cu->cu.un.n;ui++){No*u=cu->cu.un.d[ui];if(u->k==N_PKB)gel(&g,u);}fclose(o);LU*l=lu(cu->cu.un.n>0?cu->cu.un.d[0]->k:0,nm,pth);l->cmpl=true;l->ts=fts(fp);lv(&SM->lu,l);return true;}
int main(int ac,char**av){if(ac<2){fprintf(stderr,"Usage: %s <file.adb> [-o <output.ll>]\n",av[0]);return 1;}const char*inf=av[1];char*src=rf(inf);if(!src){fprintf(stderr,"Error: cannot read %s\n",inf);return 1;}Ps p=pnw(src,strlen(src),inf);No*cu=pcu(&p);if(p.er||!cu)return 1;Sm sm;smi(&sm);smu(&sm,cu);FILE*o=stdout;Gn g={o,0,0,&sm,{0},0,{0},0,{0},0,{0},12,{0},{0}};grt(&g);for(int h=0;h<4096;h++){for(Sy*s=sm.sy[h];s;s=s->nx){if(s->k==0&&s->lv==0){Vk k=s->ty?tk2v(s->ty):VK_I;char nb[256];if(s->pr&&s->pr->nm.s){int n=0;for(uint32_t i=0;i<s->pr->nm.n;i++)nb[n++]=toupper(s->pr->nm.s[i]);nb[n++]='_';nb[n++]='_';for(uint32_t i=0;i<s->nm.n;i++)nb[n++]=toupper(s->nm.s[i]);nb[n]=0;}else snprintf(nb,256,"%.*s",(int)s->nm.n,s->nm.s);fprintf(o,"@%s=global %s 0\n",nb,vt(k));}}}for(uint32_t i=0;i<sm.eo;i++){for(uint32_t j=0;j<4096;j++){for(Sy*s=sm.sy[j];s;s=s->nx){if(s->el==i&&s->lv==0){for(uint32_t k=0;k<s->ol.n;k++)gdl(&g,s->ol.d[k]);}}}}for(uint32_t ui=0;ui<cu->cu.un.n;ui++){No*u=cu->cu.un.d[ui];if(u->k==N_PKB)gel(&g,u);}for(uint32_t ui=cu->cu.un.n;ui>0;ui--){No*u=cu->cu.un.d[ui-1];if(u->k==N_PB){No*sp=u->bd.sp;fprintf(o,"define i32 @main(){\n  call void @\"%.*s.%d\"(ptr null)\n  ret i32 0\n}\n",(int)sp->sp.nm.n,sp->sp.nm.s,u->bd.el);break;}}char bfn[512];strncpy(bfn,inf,512);char*dt=strrchr(bfn,'.');if(dt)*dt=0;for(uint32_t i=0;i<g.exs.n;i++){S ex=g.exs.d[i];fprintf(o,"@.ex.%.*s=linkonce_odr constant[%d x i8]c\"%.*s\\00\"\n",(int)ex.n,ex.s,(int)ex.n+1,(int)ex.n,ex.s);}wali(&sm,bfn,cu);return 0;}
