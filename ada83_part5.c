static Ty*rst(Sm*SM,No*n);static void rex(Sm*SM,No*n,Ty*tx);static void rss(Sm*SM,No*n);static void rdl(Sm*SM,No*n);static void rrc_(Sm*SM,RC*r);static No*gcl(Sm*SM,No*n);
static Ty*tcc(Ty*t){if(!t)return TY_INT;if(t->k==TY_UI)return TY_INT;if(t->k==TY_UF)return TY_FLT;if(t->k==TY_FX)return TY_INT;if(t->k==TY_D&&t->prt)return tcc(t->prt);return t;}
static bool tco(Ty*a,Ty*b){if(!a||!b)return false;if(a==b)return true;if(a->prt==b||b->prt==a)return true;if(a->bs==b||b->bs==a)return true;if((a->k==TY_I||a->k==TY_UI)&&(b->k==TY_I||b->k==TY_UI))return true;if((a->k==TY_F||a->k==TY_UF)&&(b->k==TY_F||b->k==TY_UF))return true;if(a->k==TY_AC&&b->k==TY_AC)return tco(a->el,b->el);if(a->k==TY_D)return tco(a->prt,b);if(b->k==TY_D)return tco(a,b->prt);return false;}
static Ty*rst(Sm*SM,No*n){if(!n)return TY_INT;if(n->k==N_ID){Sy*s=syf(SM,n->s);if(s&&s->ty)return s->ty;return TY_INT;}if(n->k==N_SEL){No*p=n->se.p;if(p->k==N_ID){Sy*ps=syf(SM,p->s);if(ps&&ps->k==6&&ps->df&&ps->df->k==N_PKS){No*pk=ps->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->k==N_TD&&si(d->td.nm,n->se.se))return rst(SM,d->td.df);if(d->sy&&si(d->sy->nm,n->se.se)&&d->sy->ty)return d->sy->ty;}}return rst(SM,p);}return TY_INT;}if(n->k==N_ST)return rst(SM,n->sd.in);if(n->k==N_TI){rex(SM,n->rn.lo,0);rex(SM,n->rn.hi,0);Ty*t=tyn(TY_I,N);if(n->rn.lo&&n->rn.lo->k==N_INT)t->lo=n->rn.lo->i;else if(n->rn.lo&&n->rn.lo->k==N_UN&&n->rn.lo->un.op==T_MN&&n->rn.lo->un.x->k==N_INT)t->lo=-n->rn.lo->un.x->i;if(n->rn.hi&&n->rn.hi->k==N_INT)t->hi=n->rn.hi->i;else if(n->rn.hi&&n->rn.hi->k==N_UN&&n->rn.hi->un.op==T_MN&&n->rn.hi->un.x->k==N_INT)t->hi=-n->rn.hi->un.x->i;return t;}if(n->k==N_TX){Ty*t=tyn(TY_FX,N);double d=1.0;if(n->rn.lo&&n->rn.lo->k==N_REAL)d=n->rn.lo->f;else if(n->rn.lo&&n->rn.lo->k==N_INT)d=n->rn.lo->i;t->sm=(int64_t)(1.0/d);if(n->rn.hi&&n->rn.hi->k==N_INT)t->lo=n->rn.hi->i;if(n->bn.r&&n->bn.r->k==N_INT)t->hi=n->bn.r->i;return t;}if(n->k==N_TE)return tyn(TY_I,N);if(n->k==N_TF)return tyn(TY_F,N);if(n->k==N_TA){Ty*t=tyn(TY_A,N);t->el=rst(SM,n->ix.p);if(n->ix.ix.n==1){No*r=n->ix.ix.d[0];if(r&&r->k==N_RN&&r->rn.lo&&r->rn.hi&&r->rn.lo->k==N_INT&&r->rn.hi->k==N_INT){t->lo=r->rn.lo->i;t->hi=r->rn.hi->i;}}return t;}if(n->k==N_TR||n->k==N_TP)return tyn(TY_R,N);if(n->k==N_TAC){Ty*t=tyn(TY_AC,N);t->el=rst(SM,n->un.x);return t;}if(n->k==N_RN){rex(SM,n->rn.lo,0);rex(SM,n->rn.hi,0);Ty*t=tyn(TY_I,N);if(n->rn.lo&&n->rn.lo->k==N_INT)t->lo=n->rn.lo->i;else if(n->rn.lo&&n->rn.lo->k==N_UN&&n->rn.lo->un.op==T_MN&&n->rn.lo->un.x->k==N_INT)t->lo=-n->rn.lo->un.x->i;if(n->rn.hi&&n->rn.hi->k==N_INT)t->hi=n->rn.hi->i;else if(n->rn.hi&&n->rn.hi->k==N_UN&&n->rn.hi->un.op==T_MN&&n->rn.hi->un.x->k==N_INT)t->hi=-n->rn.hi->un.x->i;return t;}return TY_INT;}
static Sy*scl(Sm*SM,char c,Ty*tx){if(tx&&tx->k==TY_E){for(uint32_t i=0;i<tx->ev.n;i++){Sy*e=tx->ev.d[i];if(e->nm.n==1&&tolower(e->nm.s[0])==tolower(c))return e;}}if(tx&&tx->k==TY_D&&tx->prt)return scl(SM,c,tx->prt);for(Sy*s=SM->sy[syh((S){&c,1})];s;s=s->nx)if(s->nm.n==1&&tolower(s->nm.s[0])==tolower(c)&&s->k==2&&s->ty&&(s->ty->k==TY_E||(s->ty->k==TY_D&&s->ty->prt&&s->ty->prt->k==TY_E)))return s;return 0;}
static No*chk(Sm*SM,No*n,L l){if(!n||!n->ty)return n;Ty*t=tcc(n->ty);if(t->k==TY_I&&(t->lo!=TY_INT->lo||t->hi!=TY_INT->hi)&&!(t->sup&CHK_RNG)){No*c=ND(CHK,l);c->chk.ex=n;c->chk.ec=Z("CONSTRAINT_ERROR");c->ty=n->ty;return c;}return n;}
static void icv(Ty*t,No*n){if(!t||!n||n->k!=N_CL)return;for(uint32_t i=0;i<n->cl.ar.n;i++)rex(0,n->cl.ar.d[i],0);}
static void rex(Sm*SM,No*n,Ty*tx){if(!n)return;switch(n->k){case N_ID:{Sy*s=syf(SM,n->s);if(s){n->ty=s->ty;n->sy=s;}else{if(tx&&tx->k==TY_E){for(uint32_t i=0;i<tx->ev.n;i++){Sy*e=tx->ev.d[i];if(si(e->nm,n->s)){n->ty=tx;n->sy=e;return;}}}n->ty=TY_INT;}}break;case N_INT:n->ty=TY_UINT;break;case N_REAL:n->ty=TY_UFLT;break;case N_CHAR:{Sy*s=scl(SM,n->i,tx);if(s){n->ty=s->ty;n->sy=s;n->k=N_ID;n->s=s->nm;}else n->ty=TY_CHAR;}break;case N_STR:n->ty=TY_STR;break;case N_NULL:n->ty=tx&&tx->k==TY_AC?tx:TY_INT;break;case N_BIN:rex(SM,n->bn.l,tx);rex(SM,n->bn.r,tx);if(n->bn.op==T_ATHN||n->bn.op==T_OREL){n->ty=TY_BOOL;break;}if(n->bn.op==T_AND||n->bn.op==T_OR||n->bn.op==T_XOR){n->bn.l=chk(SM,n->bn.l,n->l);n->bn.r=chk(SM,n->bn.r,n->l);n->ty=TY_BOOL;break;}if(n->bn.op==T_IN){n->bn.l=chk(SM,n->bn.l,n->l);n->bn.r=chk(SM,n->bn.r,n->l);n->ty=TY_BOOL;break;}if(n->bn.l->k==N_INT&&n->bn.r->k==N_INT&&(n->bn.op==T_PL||n->bn.op==T_MN||n->bn.op==T_ST||n->bn.op==T_SL||n->bn.op==T_MOD||n->bn.op==T_REM)){int64_t a=n->bn.l->i,b=n->bn.r->i,r=0;if(n->bn.op==T_PL)r=a+b;else if(n->bn.op==T_MN)r=a-b;else if(n->bn.op==T_ST)r=a*b;else if(n->bn.op==T_SL&&b!=0)r=a/b;else if((n->bn.op==T_MOD||n->bn.op==T_REM)&&b!=0)r=a%b;n->k=N_INT;n->i=r;n->ty=TY_UINT;}else{n->ty=tcc(n->bn.l->ty);}if(n->bn.op>=T_EQ&&n->bn.op<=T_GE)n->ty=TY_BOOL;break;case N_UN:rex(SM,n->un.x,tx);n->ty=tcc(n->un.x->ty);if(n->un.op==T_NOT)n->ty=TY_BOOL;break;case N_IX:rex(SM,n->ix.p,0);for(uint32_t i=0;i<n->ix.ix.n;i++){rex(SM,n->ix.ix.d[i],0);n->ix.ix.d[i]=chk(SM,n->ix.ix.d[i],n->l);}if(n->ix.p->ty&&n->ix.p->ty->k==TY_A)n->ty=n->ix.p->ty->el;else n->ty=TY_INT;break;case N_SL:rex(SM,n->sl.p,0);rex(SM,n->sl.lo,0);rex(SM,n->sl.hi,0);if(n->sl.p->ty&&n->sl.p->ty->k==TY_A)n->ty=n->sl.p->ty;else n->ty=TY_INT;break;case N_SEL:{rex(SM,n->se.p,0);No*p=n->se.p;if(p->k==N_ID){Sy*ps=syf(SM,p->s);if(ps&&ps->k==6&&ps->df&&ps->df->k==N_PKS){No*pk=ps->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->sy&&si(d->sy->nm,n->se.se)){n->ty=d->sy->ty?d->sy->ty:TY_INT;n->sy=d->sy;return;}}}}if(p->ty){Ty*pt=tcc(p->ty);if(pt->k==TY_R){for(uint32_t i=0;i<pt->cm.n;i++){No*c=pt->cm.d[i];if(c->k==N_CM&&si(c->cm.nm,n->se.se)){n->ty=rst(SM,c->cm.ty);return;}}}}n->ty=TY_INT;}break;case N_AT:rex(SM,n->at.p,0);for(uint32_t i=0;i<n->at.ar.n;i++)rex(SM,n->at.ar.d[i],0);{Ty*pt=n->at.p?tcc(n->at.p->ty):0;S a=n->at.at;if(si(a,Z("FIRST"))||si(a,Z("LAST")))n->ty=pt&&pt->el?pt->el:(pt&&(pt->k==TY_I||pt->k==TY_E))?pt:TY_INT;else if(si(a,Z("LENGTH"))||si(a,Z("SIZE"))||si(a,Z("POS"))||si(a,Z("COUNT"))||si(a,Z("ADDRESS"))||si(a,Z("STORAGE_SIZE"))||si(a,Z("POSITION"))||si(a,Z("FIRST_BIT"))||si(a,Z("LAST_BIT"))||si(a,Z("AFT"))||si(a,Z("FORE"))||si(a,Z("WIDTH"))||si(a,Z("DIGITS"))||si(a,Z("MANTISSA"))||si(a,Z("MACHINE_EMAX"))||si(a,Z("MACHINE_EMIN"))||si(a,Z("MACHINE_MANTISSA"))||si(a,Z("MACHINE_RADIX"))||si(a,Z("SAFE_EMAX"))||si(a,Z("EMAX")))n->ty=TY_INT;else if(si(a,Z("DELTA"))||si(a,Z("EPSILON"))||si(a,Z("SMALL"))||si(a,Z("LARGE"))||si(a,Z("SAFE_LARGE"))||si(a,Z("SAFE_SMALL")))n->ty=TY_FLT;else if(si(a,Z("CALLABLE"))||si(a,Z("TERMINATED"))||si(a,Z("CONSTRAINED"))||si(a,Z("MACHINE_OVERFLOWS"))||si(a,Z("MACHINE_ROUNDS")))n->ty=TY_BOOL;else if(si(a,Z("ACCESS")))n->ty=tyn(TY_AC,N);else if(si(a,Z("IMAGE")))n->ty=TY_STR;else if(si(a,Z("VALUE"))||si(a,Z("SUCC"))||si(a,Z("PRED"))||si(a,Z("VAL")))n->ty=pt?pt:TY_INT;else if(si(a,Z("RANGE")))n->ty=TY_INT;else if(si(a,Z("BASE")))n->ty=pt&&pt->bs?pt->bs:pt;else n->ty=TY_INT;}break;case N_QL:{Ty*qt=rst(SM,n->ql.nm);rex(SM,n->ql.ag,qt);n->ty=qt;if(n->ql.ag->ty&&qt){icv(qt,n->ql.ag);n->ql.ag->ty=qt;}}break;case N_CL:{rex(SM,n->cl.fn,0);for(uint32_t i=0;i<n->cl.ar.n;i++)rex(SM,n->cl.ar.d[i],0);Ty*ft=n->cl.fn?n->cl.fn->ty:0;if(ft&&ft->k==TY_A){No*fn=n->cl.fn;NV ar=n->cl.ar;n->k=N_IX;n->ix.p=fn;n->ix.ix=ar;rex(SM,n,tx);break;}if(n->cl.fn->k==N_ID){Sy*s=syfa(SM,n->cl.fn->s,n->cl.ar.n,tx);if(s){if(s->ty&&s->ty->k==TY_S&&s->ty->el){n->ty=s->ty->el;n->sy=s;}else if(s->k==1){No*cv=ND(CVT,n->l);cv->cvt.ty=n->cl.fn;cv->cvt.ex=n->cl.ar.n>0?n->cl.ar.d[0]:0;n->k=N_CVT;n->cvt=cv->cvt;n->ty=s->ty?s->ty:TY_INT;}else n->ty=TY_INT;}else n->ty=TY_INT;}else n->ty=TY_INT;}break;case N_AG:for(uint32_t i=0;i<n->ag.it.n;i++)rex(SM,n->ag.it.d[i],tx);n->ty=tx?tx:TY_INT;icv(tx,n);break;case N_ALC:n->ty=tyn(TY_AC,N);n->ty->el=rst(SM,n->alc.st);if(n->alc.in){Ty*et=n->ty->el?tcc(n->ty->el):0;if(et&&et->k==TY_R&&et->dc.n>0){for(uint32_t i=0;i<et->dc.n;i++){No*d=et->dc.d[i];if(d->k==N_DS&&d->pm.df){rex(SM,d->pm.df,rst(SM,d->pm.ty));}}}rex(SM,n->alc.in,n->ty->el);}break;case N_RN:rex(SM,n->rn.lo,tx);rex(SM,n->rn.hi,tx);n->rn.lo=chk(SM,n->rn.lo,n->l);n->rn.hi=chk(SM,n->rn.hi,n->l);n->ty=tcc(n->rn.lo->ty);break;case N_ASC:for(uint32_t i=0;i<n->asc.ch.n;i++)rex(SM,n->asc.ch.d[i],0);if(n->asc.vl)rex(SM,n->asc.vl,tx);break;case N_DRF:rex(SM,n->drf.x,0);if(n->drf.x->ty&&n->drf.x->ty->k==TY_AC)n->ty=n->drf.x->ty->el;else n->ty=TY_INT;break;case N_CVT:rex(SM,n->cvt.ex,0);n->ty=rst(SM,n->cvt.ty);break;case N_CHK:rex(SM,n->chk.ex,tx);n->ty=n->chk.ex->ty;break;default:break;}}
static void rss(Sm*SM,No*n){if(!n)return;switch(n->k){case N_AS:rex(SM,n->as.tg,0);rex(SM,n->as.vl,n->as.tg->ty);break;case N_IF:rex(SM,n->if_.cd,TY_BOOL);for(uint32_t i=0;i<n->if_.th.n;i++)rss(SM,n->if_.th.d[i]);for(uint32_t i=0;i<n->if_.ei.n;i++){No*e=n->if_.ei.d[i];rex(SM,e->if_.cd,TY_BOOL);for(uint32_t j=0;j<e->if_.th.n;j++)rss(SM,e->if_.th.d[j]);}for(uint32_t i=0;i<n->if_.el.n;i++)rss(SM,n->if_.el.d[i]);break;case N_CS:rex(SM,n->cs.ex,0);for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];for(uint32_t j=0;j<a->ch.it.n;j++)rex(SM,a->ch.it.d[j],n->cs.ex->ty);for(uint32_t j=0;j<a->hnd.stz.n;j++)rss(SM,a->hnd.stz.d[j]);}break;case N_LP:if(n->lp.it){if(n->lp.it->k==N_BIN&&n->lp.it->bn.op==T_IN){No*v=n->lp.it->bn.l;if(v->k==N_ID){Ty*rt=n->lp.it->bn.r->ty;Sy*lvs=syn(v->s,0,rt?rt:TY_INT,0);sya(SM,lvs);v->sy=lvs;}}rex(SM,n->lp.it,TY_BOOL);}for(uint32_t i=0;i<n->lp.st.n;i++)rss(SM,n->lp.st.d[i]);break;case N_BL:scp(SM);for(uint32_t i=0;i<n->bk.dc.n;i++)rdl(SM,n->bk.dc.d[i]);for(uint32_t i=0;i<n->bk.st.n;i++)rss(SM,n->bk.st.d[i]);for(uint32_t i=0;i<n->bk.hd.n;i++){No*h=n->bk.hd.d[i];for(uint32_t j=0;j<h->hnd.stz.n;j++)rss(SM,h->hnd.stz.d[j]);}sco(SM);break;case N_RT:if(n->rt.vl)rex(SM,n->rt.vl,0);break;case N_EX:if(n->ex.cd)rex(SM,n->ex.cd,TY_BOOL);break;case N_RS:if(n->rs.ec)rex(SM,n->rs.ec,0);break;case N_CLT:rex(SM,n->ct.nm,0);for(uint32_t i=0;i<n->ct.arr.n;i++)rex(SM,n->ct.arr.d[i],0);break;case N_ACC:for(uint32_t i=0;i<n->acc.pmx.n;i++){No*p=n->acc.pmx.d[i];rex(SM,p,0);}for(uint32_t i=0;i<n->acc.stx.n;i++)rss(SM,n->acc.stx.d[i]);break;case N_SA:if(n->sa.gd)rex(SM,n->sa.gd,0);for(uint32_t i=0;i<n->sa.sts.n;i++){No*s=n->sa.sts.d[i];if(s->k==N_ACC){for(uint32_t j=0;j<s->acc.pmx.n;j++)rex(SM,s->acc.pmx.d[j],0);for(uint32_t j=0;j<s->acc.stx.n;j++)rss(SM,s->acc.stx.d[j]);}else if(s->k==N_DL)rex(SM,s->ex.cd,0);}break;case N_DL:rex(SM,n->ex.cd,0);break;case N_AB:if(n->rs.ec)rex(SM,n->rs.ec,0);break;case N_US:if(n->us.nm->k==N_ID){Sy*s=syf(SM,n->us.nm->s);if(s)sfu(SM,s,n->us.nm->s);}break;default:break;}}
static void rrc_(Sm*SM,RC*r){if(!r)return;switch(r->k){case 1:{Sy*ts=syf(SM,r->er.nm);if(ts&&ts->ty){Ty*t=tcc(ts->ty);for(uint32_t i=0;i<r->rr.cp.n;i++){No*e=r->rr.cp.d[i];for(uint32_t j=0;j<t->ev.n;j++){Sy*ev=t->ev.d[j];if(si(ev->nm,e->s)){ev->vl=e->i;break;}}}}}break;case 2:{Sy*s=syf(SM,r->ad.nm);if(s&&s->ty){Ty*t=tcc(s->ty);t->ad=r->ad.ad;}}break;case 3:{Sy*s=syf(SM,r->rr.nm);if(s&&s->ty){Ty*t=tcc(s->ty);uint32_t bt=0;for(uint32_t i=0;i<r->rr.cp.n;i++){No*cp=r->rr.cp.d[i];for(uint32_t j=0;j<t->cm.n;j++){No*c=t->cm.d[j];if(c->k==N_CM&&si(c->cm.nm,cp->cm.nm)){c->cm.of=cp->cm.of;c->cm.bt=cp->cm.bt;bt+=cp->cm.bt;break;}}}t->sz=(bt+7)/8;t->pk=true;}}break;case 4:{Sy*s=r->ad.nm.n>0?syf(SM,r->ad.nm):0;if(s&&s->ty){Ty*t=tcc(s->ty);t->sup|=r->ad.ad;}}break;case 5:{Sy*s=syf(SM,r->er.nm);if(s&&s->ty){Ty*t=tcc(s->ty);t->pk=true;}}break;case 6:{Sy*s=syf(SM,r->er.nm);if(s)s->inl=true;}break;case 7:{Sy*s=syf(SM,r->er.nm);if(s&&s->ty){Ty*t=tcc(s->ty);t->ctrl=true;}}break;case 8:{Sy*s=syf(SM,r->im.nm);if(s){s->ext=true;s->ext_nm=r->im.ext.n>0?r->im.ext:r->im.nm;s->ext_lang=r->im.lang;}}break;}}
static void ihop(Ty*dt,Ty*pt){if(!dt||!pt)return;for(uint32_t i=0;i<pt->ops.n;i++){No*op=pt->ops.d[i];if(op->k==N_FB||op->k==N_PB){No*nop=nd(op->k,op->l);nop->bd=op->bd;No*nsp=nd(N_FS,op->l);nsp->sp=op->bd.sp->sp;nsp->sp.nm=op->bd.sp->sp.nm;nsp->sp.pmm=op->bd.sp->sp.pmm;if(op->k==N_FB)nsp->sp.rt=op->bd.sp->sp.rt;nop->bd.sp=nsp;nop->bd.el=-1;nv(&dt->ops,nop);}}}
static No*ncp(No*n){if(!n)return 0;No*c=nd(n->k,n->l);*c=*n;if(n->k==N_BIN){c->bn.l=ncp(n->bn.l);c->bn.r=ncp(n->bn.r);}else if(n->k==N_UN){c->un.x=ncp(n->un.x);}else if(n->k==N_CL){c->cl.fn=ncp(n->cl.fn);for(uint32_t i=0;i<n->cl.ar.n;i++)c->cl.ar.d[i]=ncp(n->cl.ar.d[i]);}else if(n->k==N_AG){for(uint32_t i=0;i<n->ag.it.n;i++)c->ag.it.d[i]=ncp(n->ag.it.d[i]);}else if(n->k==N_PKS){uint32_t ndc=n->ps.dc.n,npr=n->ps.pr.n;c->ps.dc.n=0;c->ps.dc.c=0;c->ps.dc.d=0;c->ps.pr.n=0;c->ps.pr.c=0;c->ps.pr.d=0;for(uint32_t i=0;i<ndc;i++)nv(&c->ps.dc,ncp(n->ps.dc.d[i]));for(uint32_t i=0;i<npr;i++)nv(&c->ps.pr,ncp(n->ps.pr.d[i]));}else if(n->k==N_PKB){uint32_t ndc=n->pb.dc.n,nst=n->pb.st.n;c->pb.dc.n=0;c->pb.dc.c=0;c->pb.dc.d=0;c->pb.st.n=0;c->pb.st.c=0;c->pb.st.d=0;for(uint32_t i=0;i<ndc;i++)nv(&c->pb.dc,ncp(n->pb.dc.d[i]));for(uint32_t i=0;i<nst;i++)nv(&c->pb.st,ncp(n->pb.st.d[i]));}else if(n->k==N_PB||n->k==N_FB||n->k==N_PD||n->k==N_FD){uint32_t ndc=n->bd.dc.n,nst=n->bd.st.n;c->bd.dc.n=0;c->bd.dc.c=0;c->bd.dc.d=0;c->bd.st.n=0;c->bd.st.c=0;c->bd.st.d=0;for(uint32_t i=0;i<ndc;i++)nv(&c->bd.dc,ncp(n->bd.dc.d[i]));for(uint32_t i=0;i<nst;i++)nv(&c->bd.st,ncp(n->bd.st.d[i]));}return c;}
static No*gsub(Sm*SM,No*n,NV*fp,NV*ap){if(!n)return n;No*r=ncp(n);switch(n->k){case N_ID:for(uint32_t i=0;i<fp->n;i++){No*f=fp->d[i];if((f->k==N_GTP||f->k==N_GVL)&&si(f->td.nm,n->s)){if(i<ap->n)return ncp(ap->d[i]);}}return r;case N_BIN:r->bn.l=gsub(SM,n->bn.l,fp,ap);r->bn.r=gsub(SM,n->bn.r,fp,ap);break;case N_UN:r->un.x=gsub(SM,n->un.x,fp,ap);break;case N_CL:r->cl.fn=gsub(SM,n->cl.fn,fp,ap);for(uint32_t i=0;i<n->cl.ar.n;i++)r->cl.ar.d[i]=gsub(SM,n->cl.ar.d[i],fp,ap);break;case N_PM:r->pm.ty=gsub(SM,n->pm.ty,fp,ap);break;case N_OD:r->od.ty=gsub(SM,n->od.ty,fp,ap);break;case N_TD:r->td.df=gsub(SM,n->td.df,fp,ap);break;case N_TA:for(uint32_t i=0;i<n->ix.ix.n;i++)r->ix.ix.d[i]=gsub(SM,n->ix.ix.d[i],fp,ap);r->ix.p=gsub(SM,n->ix.p,fp,ap);break;default:break;}return r;}
static No*gcl(Sm*SM,No*n){if(!n)return 0;if(n->k==N_GEN){GT*g=gfnd(SM,n->gen.un&&n->gen.un->bd.sp?n->gen.un->bd.sp->sp.nm:n->gen.un?((n->gen.un->k==N_PKS)?n->gen.un->ps.nm:N):N);if(!g){g=gt(n->gen.un&&n->gen.un->bd.sp?n->gen.un->bd.sp->sp.nm:n->gen.un?((n->gen.un->k==N_PKS)?n->gen.un->ps.nm:N):N);g->fp=n->gen.fp;g->dc=n->gen.dc;g->un=n->gen.un;gv(&SM->gt,g);Sy*gs=syn(g->nm,11,0,n);gs->gt=g;sya(SM,gs);}}else if(n->k==N_GINST){GT*g=gfnd(SM,n->gi.gn);if(g){No*inst=ncp(g->un);if(inst->k==N_PB||inst->k==N_FB||inst->k==N_PD||inst->k==N_FD){for(uint32_t i=0;i<inst->bd.sp->sp.pmm.n;i++){No*p=inst->bd.sp->sp.pmm.d[i];p->pm.ty=gsub(SM,p->pm.ty,&g->fp,&n->gi.ap);}if((inst->k==N_FB||inst->k==N_FD)&&inst->bd.sp->sp.rt)inst->bd.sp->sp.rt=gsub(SM,inst->bd.sp->sp.rt,&g->fp,&n->gi.ap);for(uint32_t i=0;i<g->dc.n;i++){No*d=ncp(g->dc.d[i]);if(d->k==N_TD)d->td.df=gsub(SM,d->td.df,&g->fp,&n->gi.ap);else if(d->k==N_OD)d->od.ty=gsub(SM,d->od.ty,&g->fp,&n->gi.ap);nv(&inst->bd.dc,d);}}else if(inst->k==N_PKS){for(uint32_t i=0;i<g->dc.n;i++){No*d=ncp(g->dc.d[i]);if(d->k==N_TD)d->td.df=gsub(SM,d->td.df,&g->fp,&n->gi.ap);else if(d->k==N_OD)d->od.ty=gsub(SM,d->od.ty,&g->fp,&n->gi.ap);nv(&inst->ps.dc,d);}}return inst;}}return 0;}
static void rdl(Sm*SM,No*n){if(!n)return;switch(n->k){case N_GINST:{No*inst=gcl(SM,n);if(inst)rdl(SM,inst);}break;case N_RRC:{RC*r=(RC*)(void*)n->ag.it.d;rrc_(SM,r);}break;case N_OD:{Ty*t=rst(SM,n->od.ty);for(uint32_t i=0;i<n->od.id.n;i++){No*id=n->od.id.d[i];Sy*s=sya(SM,syn(id->s,n->od.co?2:0,t,n));id->sy=s;s->pr=SM->pk?SM->pk->sy:0;if(n->od.in){rex(SM,n->od.in,t);if(n->od.co&&n->od.in->k==N_INT)s->vl=n->od.in->i;else if(n->od.co&&n->od.in->k==N_ID&&n->od.in->sy&&n->od.in->sy->k==2)s->vl=n->od.in->sy->vl;else if(n->od.co&&n->od.in->k==N_AT){Ty*pt=n->od.in->at.p?tcc(n->od.in->at.p->ty):0;S a=n->od.in->at.at;if(pt&&si(a,Z("FIRST")))s->vl=pt->lo;else if(pt&&si(a,Z("LAST")))s->vl=pt->hi;}else if(n->od.co&&n->od.in->k==N_QL&&n->od.in->ql.ag){No*ag=n->od.in->ql.ag;if(ag->k==N_ID&&ag->sy&&ag->sy->k==2)s->vl=ag->sy->vl;else if(ag->k==N_INT)s->vl=ag->i;}}}}break;case N_TD:{uint32_t of=0;Ty*t=0;if(n->td.drv&&n->td.prt){Ty*pt=rst(SM,n->td.prt);t=tyn(TY_D,n->td.nm);t->prt=pt;if(pt){t->k=pt->k==TY_D?pt->prt->k:pt->k;t->lo=pt->lo;t->hi=pt->hi;t->el=pt->el;t->cm=pt->cm;t->dc=pt->dc;t->sz=pt->sz;t->al=pt->al;t->ev=pt->ev;ihop(t,pt);}if(n->td.df&&n->td.df->k==N_RN){rex(SM,n->td.df->rn.lo,0);rex(SM,n->td.df->rn.hi,0);t->lo=n->td.df->rn.lo->i;t->hi=n->td.df->rn.hi->i;}}else{Sy*px=syf(SM,n->td.nm);if(px&&px->k==1&&px->ty&&px->ty->k==TY_I&&n->td.df){t=px->ty;}else if(n->td.df){t=rst(SM,n->td.df);}else{t=tyn(TY_I,n->td.nm);if(t&&n->td.nm.s){Sy*s=sya(SM,syn(n->td.nm,1,t,n));n->sy=s;}break;}}if(t&&n->td.nm.s&&n->td.nm.n>0&&!t->nm.s)t->nm=n->td.nm;if(n->td.dsc.n>0){for(uint32_t i=0;i<n->td.dsc.n;i++){No*d=n->td.dsc.d[i];if(d->k==N_DS){Sy*ds=sya(SM,syn(d->pm.nm,8,rst(SM,d->pm.ty),d));if(d->pm.df)rex(SM,d->pm.df,ds->ty);}}t->dc=n->td.dsc;}if(n->td.nm.s&&n->td.nm.n>0){Sy*px2=syf(SM,n->td.nm);if(px2&&px2->k==1&&px2->ty==t){n->sy=px2;if(n->td.df)px2->df=n;}else{Sy*s=sya(SM,syn(n->td.nm,1,t,n));n->sy=s;}}if(n->td.df&&n->td.df->k==N_TE){t->k=TY_E;int vl=0;for(uint32_t i=0;i<n->td.df->lst.it.n;i++){No*it=n->td.df->lst.it.d[i];Sy*es=sya(SM,syn(it->k==N_CHAR?(S){(const char*)&it->i,1}:it->s,2,t,n));es->vl=vl++;sv(&t->ev,es);}t->lo=0;t->hi=vl-1;}if(n->td.df&&n->td.df->k==N_TR){t->k=TY_R;of=0;for(uint32_t i=0;i<n->td.df->lst.it.n;i++){No*c=n->td.df->lst.it.d[i];if(c->k==N_CM){c->cm.of=of++;Ty*ct=rst(SM,c->cm.ty);if(ct)c->cm.ty->ty=ct;if(c->cm.dc){for(uint32_t j=0;j<c->cm.dc->lst.it.n;j++){No*dc=c->cm.dc->lst.it.d[j];if(dc->k==N_DS&&dc->pm.df)rex(SM,dc->pm.df,rst(SM,dc->pm.ty));}}if(c->cm.dsc){for(uint32_t j=0;j<c->cm.dsc->lst.it.n;j++){No*dc=c->cm.dsc->lst.it.d[j];if(dc->k==N_DS){Sy*ds=sya(SM,syn(dc->pm.nm,8,rst(SM,dc->pm.ty),dc));if(dc->pm.df)rex(SM,dc->pm.df,ds->ty);}}c->cm.dc=c->cm.dsc;}}else if(c->k==N_VP){for(uint32_t j=0;j<c->vp.vrr.n;j++){No*v=c->vp.vrr.d[j];for(uint32_t k=0;k<v->vr.cmm.n;k++){No*vc=v->vr.cmm.d[k];vc->cm.of=of++;Ty*vct=rst(SM,vc->cm.ty);if(vct)vc->cm.ty->ty=vct;if(vc->cm.dc){for(uint32_t m=0;m<vc->cm.dc->lst.it.n;m++){No*dc=vc->cm.dc->lst.it.d[m];if(dc->k==N_DS&&dc->pm.df)rex(SM,dc->pm.df,rst(SM,dc->pm.ty));}}if(vc->cm.dsc){for(uint32_t m=0;m<vc->cm.dsc->lst.it.n;m++){No*dc=vc->cm.dsc->lst.it.d[m];if(dc->k==N_DS){Sy*ds=sya(SM,syn(dc->pm.nm,8,rst(SM,dc->pm.ty),dc));if(dc->pm.df)rex(SM,dc->pm.df,ds->ty);}}vc->cm.dc=vc->cm.dsc;}}}}}}t->cm=n->td.df->lst.it;t->sz=of*8;}break;case N_SD:{Ty*b=rst(SM,n->sd.in);Ty*t=tyn(b?b->k:TY_I,n->sd.nm);if(b){t->bs=b;t->el=b->el;t->cm=b->cm;t->dc=b->dc;t->sz=b->sz;t->al=b->al;t->ad=b->ad;t->pk=b->pk;t->lo=b->lo;t->hi=b->hi;t->prt=b->prt?b->prt:b;}if(n->sd.rn){rex(SM,n->sd.rn->rn.lo,0);rex(SM,n->sd.rn->rn.hi,0);No*lo=n->sd.rn->rn.lo;No*hi=n->sd.rn->rn.hi;int64_t lov=lo->k==N_UN&&lo->un.op==T_MN&&lo->un.x->k==N_INT?-lo->un.x->i:lo->k==N_ID&&lo->sy&&lo->sy->k==2?lo->sy->vl:lo->i;int64_t hiv=hi->k==N_UN&&hi->un.op==T_MN&&hi->un.x->k==N_INT?-hi->un.x->i:hi->k==N_ID&&hi->sy&&hi->sy->k==2?hi->sy->vl:hi->i;t->lo=lov;t->hi=hiv;}sya(SM,syn(n->sd.nm,1,t,n));}break;case N_ED:for(uint32_t i=0;i<n->ed.id.n;i++){No*id=n->ed.id.d[i];sya(SM,syn(id->s,3,0,n));}break;case N_PD:case N_PB:{No*sp=n->bd.sp;Ty*ft=tyn(TY_S,sp->sp.nm);Sy*s=sya(SM,syn(sp->sp.nm,4,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;s->pr=SM->pk?SM->pk->sy:0;nv(&ft->ops,n);if(n->k==N_PB){SM->lv++;scp(SM);n->bd.pr=s;for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Ty*pt=rst(SM,p->pm.ty);Sy*ps=sya(SM,syn(p->pm.nm,0,pt,p));p->sy=ps;}for(uint32_t i=0;i<n->bd.dc.n;i++)rdl(SM,n->bd.dc.d[i]);for(uint32_t i=0;i<n->bd.st.n;i++)rss(SM,n->bd.st.d[i]);sco(SM);SM->lv--;}}break;case N_FB:{No*sp=n->bd.sp;Ty*rt=rst(SM,sp->sp.rt);Ty*ft=tyn(TY_S,sp->sp.nm);ft->el=rt;Sy*s=sya(SM,syn(sp->sp.nm,5,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;s->pr=SM->pk?SM->pk->sy:0;nv(&ft->ops,n);if(n->k==N_FB){SM->lv++;scp(SM);n->bd.pr=s;for(uint32_t i=0;i<sp->sp.pmm.n;i++){No*p=sp->sp.pmm.d[i];Ty*pt=rst(SM,p->pm.ty);Sy*ps=sya(SM,syn(p->pm.nm,0,pt,p));p->sy=ps;}for(uint32_t i=0;i<n->bd.dc.n;i++)rdl(SM,n->bd.dc.d[i]);for(uint32_t i=0;i<n->bd.st.n;i++)rss(SM,n->bd.st.d[i]);sco(SM);SM->lv--;}}break;case N_FD:{No*sp=n->bd.sp;Ty*rt=rst(SM,sp->sp.rt);Ty*ft=tyn(TY_S,sp->sp.nm);ft->el=rt;Sy*s=sya(SM,syn(sp->sp.nm,5,ft,n));nv(&s->ol,n);n->sy=s;n->bd.el=s->el;s->pr=SM->pk?SM->pk->sy:0;nv(&ft->ops,n);}break;case N_PKS:{Ty*t=tyn(TY_P,n->ps.nm);Sy*s=sya(SM,syn(n->ps.nm,6,t,n));n->sy=s;n->ps.el=s->el;SM->pk=n;scp(SM);for(uint32_t i=0;i<n->ps.dc.n;i++)rdl(SM,n->ps.dc.d[i]);for(uint32_t i=0;i<n->ps.pr.n;i++)rdl(SM,n->ps.pr.d[i]);sco(SM);SM->pk=0;}break;case N_PKB:{Sy*ps=syf(SM,n->pb.nm);if(ps){sv(&SM->uv,ps);n->pb.el=ps->el;SM->pk=ps->df;}scp(SM);for(uint32_t i=0;i<n->pb.dc.n;i++)rdl(SM,n->pb.dc.d[i]);for(uint32_t i=0;i<n->pb.st.n;i++)rss(SM,n->pb.st.d[i]);sco(SM);SM->pk=0;}break;case N_TKS:{Ty*t=tyn(TY_T,n->ts.nm);t->cm=n->ts.en;sya(SM,syn(n->ts.nm,7,t,n));}break;case N_TKB:{scp(SM);for(uint32_t i=0;i<n->tb.dc.n;i++)rdl(SM,n->tb.dc.d[i]);for(uint32_t i=0;i<n->tb.st.n;i++)rss(SM,n->tb.st.d[i]);sco(SM);}break;case N_GEN:gcl(SM,n);break;case N_US:rss(SM,n);break;default:break;}}
static int elc(Sm*SM,SV*ev,No*n){if(!n)return 0;int mx=0;switch(n->k){case N_PKS:case N_PKB:case N_PD:case N_PB:case N_FD:case N_FB:{Sy*s=n->sy;if(s&&s->el<0)s->el=SM->eo;if(s){sv(ev,s);if(s->el>mx)mx=s->el;}}break;case N_OD:for(uint32_t i=0;i<n->od.id.n;i++){No*id=n->od.id.d[i];if(id->sy){sv(ev,id->sy);if(id->sy->el>mx)mx=id->sy->el;}}break;default:break;}return mx;}
static char*rdf(const char*p){FILE*f=fopen(p,"rb");if(!f)return 0;fseek(f,0,SEEK_END);long z=ftell(f);fseek(f,0,SEEK_SET);char*b=malloc(z+1);size_t _=fread(b,1,z,f);(void)_;b[z]=0;fclose(f);return b;}
static void rali(Sm*SM,const char*pth){char alp[512];snprintf(alp,512,"%s.ali",pth);char*ali=rdf(alp);if(!ali)return;char*l=ali;L ll={0,0,pth};while(*l){if(*l=='X'&&l[1]==' '){char*e=l+2;while(*e&&*e!=' '&&*e!='\n')e++;S sn={l+2,e-(l+2)};char*t=e;bool isp=false;int pc=0;char mn[256];int mp=0;for(uint32_t i=0;i<sn.n&&mp<250;i++)mn[mp++]=sn.s[i];while(*t&&*t!='\n'){while(*t==' ')t++;if(*t=='\n')break;char*te=t;while(*te&&*te!=' '&&*te!='\n')te++;S tn={t,te-t};if(si(tn,Z("void")))isp=true;else if(si(tn,Z("i64"))||si(tn,Z("double"))||si(tn,Z("ptr"))){pc++;if(pc>1&&mp<250){mn[mp++]='_';mn[mp++]='_';}if(si(tn,Z("i64"))&&mp<247){mn[mp++]='I';mn[mp++]='6';mn[mp++]='4';}else if(si(tn,Z("double"))&&mp<245){mn[mp++]='F';mn[mp++]='6';mn[mp++]='4';}else if(si(tn,Z("ptr"))&&mp<247){mn[mp++]='P';mn[mp++]='T';mn[mp++]='R';}}t=te;}mn[mp]=0;S msn={mn,mp};No*n=nd(isp?N_PD:N_FD,ll);No*sp=nd(N_FS,ll);sp->sp.nm=msn;for(int i=1;i<pc;i++){No*p=nd(N_PM,ll);p->pm.nm=Z("p");p->pm.ty=0;nv(&sp->sp.pmm,p);}if(!isp)sp->sp.rt=0;n->bd.sp=sp;Ty*ft=tyn(TY_S,msn);Sy*s=sya(SM,syn(msn,isp?4:5,ft,n));s->el=SM->eo++;nv(&s->ol,n);n->sy=s;}while(*l&&*l!='\n')l++;if(*l=='\n')l++;}free(ali);}
static void smu(Sm*SM,No*n){if(n->k==N_CU){for(uint32_t ui=0;ui<n->cu.un.n;ui++){No*u=n->cu.un.d[ui];if(u&&u->k==N_PKB){char pkfn[256];snprintf(pkfn,sizeof(pkfn),"rts/%.*s",(int)u->pb.nm.n,u->pb.nm.s);for(char*p=pkfn+4;*p;p++)*p=tolower(*p);rali(SM,pkfn);L ll={0,0,"<package>"};No*dn=nd(N_PKS,ll);dn->ps.nm=u->pb.nm;Ty*t=tyn(TY_P,u->pb.nm);Sy*ps=sya(SM,syn(u->pb.nm,6,t,dn));ps->el=SM->eo++;dn->sy=ps;ps->df=dn;}}for(uint32_t i=0;i<n->cu.cx->cx.wt.n;i++){No*w=n->cu.cx->cx.wt.d[i];char pkfn[256];snprintf(pkfn,sizeof(pkfn),"rts/%.*s",(int)w->wt.nm.n,w->wt.nm.s);for(char*p=pkfn+4;*p;p++)*p=tolower(*p);rali(SM,pkfn);char adsfn[512];snprintf(adsfn,sizeof(adsfn),"%s.ads",pkfn);char*pksrc=rdf(adsfn);if(pksrc){Ps pkp=pnw(pksrc,strlen(pksrc),adsfn);No*pkcu=pcu(&pkp);for(uint32_t pki=0;pki<pkcu->cu.un.n;pki++){if(pkcu->cu.un.d[pki]->k==N_PKS){rdl(SM,pkcu->cu.un.d[pki]);}}}}for(uint32_t i=0;i<n->cu.cx->cx.us.n;i++)rdl(SM,n->cu.cx->cx.us.d[i]);for(uint32_t ui2=0;ui2<n->cu.un.n;ui2++){No*u2=n->cu.un.d[ui2];SV eo={0};int mx=0;if(u2->k==N_PKS){for(uint32_t i=0;i<u2->ps.dc.n;i++){int e=elc(SM,&eo,u2->ps.dc.d[i]);if(e>mx)mx=e;}}else if(u2->k==N_PKB){for(uint32_t i=0;i<u2->pb.dc.n;i++){int e=elc(SM,&eo,u2->pb.dc.d[i]);if(e>mx)mx=e;}}for(uint32_t i=0;i<eo.n;i++){Sy*s=eo.d[i];if(s->k==6&&s->df&&s->df->k==N_PKS){No*pk=s->df;for(uint32_t j=0;j<pk->ps.dc.n;j++)rdl(SM,pk->ps.dc.d[j]);}}rdl(SM,u2);}}}
typedef enum{VK_I=0,VK_F=1,VK_P=2}Vk;typedef struct{int id;Vk k;}V;typedef struct TH TH;typedef struct TK TK;typedef struct PT PT;struct TH{S ec;jmp_buf jb;TH*nx;};struct TK{pthread_t th;int id;S nm;NV en;PT*pt;bool ac,tm;};struct PT{pthread_mutex_t mx;S nm;NV en;bool lk;};typedef struct{FILE*o;int tm,lb;Sm*sm;int ll[64];int ls;SV el;TH*eh;TK*tk[64];int tn;PT*pt[64];int pn;SLV lbs;SLV exs;}Gn;
static int nt(Gn*g){return g->tm++;}
static int nl(Gn*g){return g->lb++;}
static int flbl(Gn*g,S lb){for(uint32_t i=0;i<g->lbs.n;i++)if(si(g->lbs.d[i],lb))return i;return -1;}
static void eex(Gn*g,S ex){for(uint32_t i=0;i<g->exs.n;i++)if(si(g->exs.d[i],ex))return;slv(&g->exs,ex);}
static const char*vt(Vk k){return k==VK_I?"i64":k==VK_F?"double":"ptr";}
static Vk tk2v(Ty*t){if(!t)return VK_I;t=tcc(t);switch(t->k){case TY_F:case TY_UF:return VK_F;case TY_FT:case TY_A:case TY_R:return VK_P;case TY_AC:return VK_I;default:return VK_I;}}
static int esn(char*b,int sz,Sy*s,S nm){int n=0;if(s&&s->pr&&s->pr->nm.s){for(uint32_t i=0;i<s->pr->nm.n;i++){char c=s->pr->nm.s[i];if((c>='a'&&c<='z')||(c>='A'&&c<='Z')||(c>='0'&&c<='9'))b[n++]=toupper(c);else n+=snprintf(b+n,sz-n,"_%02X",(unsigned char)c);}b[n++]='_';b[n++]='_';for(uint32_t i=0;i<nm.n;i++){char c=nm.s[i];if((c>='a'&&c<='z')||(c>='A'&&c<='Z')||(c>='0'&&c<='9'))b[n++]=toupper(c);else n+=snprintf(b+n,sz-n,"_%02X",(unsigned char)c);}b[n]=0;return n;}for(uint32_t i=0;i<nm.n;i++){char c=nm.s[i];if((c>='a'&&c<='z')||(c>='A'&&c<='Z')||(c>='0'&&c<='9')||c=='_')b[n++]=c;else n+=snprintf(b+n,sz-n,"_%02X",(unsigned char)c);}n+=snprintf(b+n,sz-n,".%d",s?s->el:0);return n;}
static V gex(Gn*g,No*n);static void gss(Gn*g,No*n);static void gbf(Gn*g){
int mx=g->sm->eo;
if(mx>0)fprintf(g->o,"  %%__frame = alloca [%d x ptr]\n",mx);
