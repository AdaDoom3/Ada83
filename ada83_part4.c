static No*plp(Ps*p,S lb){L lc=pl(p);No*n=ND(LP,lc);n->lp.lb=lb;if(pm(p,T_WHI))n->lp.it=pex(p);else if(pm(p,T_FOR)){S vr=pi(p);pe(p,T_IN);n->lp.rv=pm(p,T_REV);No*rng=prn(p);if(pm(p,T_RNG)){No*r=ND(RN,lc);r->rn.lo=psm(p);pe(p,T_DD);r->rn.hi=psm(p);rng=r;}No*it=ND(BIN,lc);it->bn.op=T_IN;it->bn.l=ND(ID,lc);it->bn.l->s=vr;it->bn.r=rng;n->lp.it=it;}pe(p,T_LOOP);while(!pa(p,T_END))nv(&n->lp.st,ps(p));pe(p,T_END);pe(p,T_LOOP);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}
static No*pbk(Ps*p,S lb){L lc=pl(p);No*n=ND(BL,lc);n->bk.lb=lb;if(pm(p,T_DEC))n->bk.dc=pdc(p);pe(p,T_BEG);while(!pa(p,T_EXCP)&&!pa(p,T_END))nv(&n->bk.st,ps(p));if(pm(p,T_EXCP))n->bk.hd=phd(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}
static No*psl(Ps*p){L lc=pl(p);pe(p,T_SEL);No*n=ND(SA,lc);n->sa.kn=0;if(pm(p,T_DEL)){n->sa.kn=1;n->sa.gd=pex(p);pe(p,T_THEN);if(pm(p,T_AB))n->sa.kn=3;while(!pa(p,T_OR)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&n->sa.sts,ps(p));}else if(pa(p,T_WHN)){while(pm(p,T_WHN)){No*g=ND(WH,lc);do nv(&g->ch.it,pex(p));while(pm(p,T_BR));pe(p,T_AR);if(pm(p,T_ACC)){g->k=N_ACC;g->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;g->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{g->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END)&&!pa(p,T_OR)&&!pa(p,T_ELSE))nv(&g->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}}else if(pm(p,T_TER)){g->k=N_TRM;}else if(pm(p,T_DEL)){g->k=N_DL;g->ex.cd=pex(p);pe(p,T_THEN);while(!pa(p,T_OR)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&g->hnd.stz,ps(p));}nv(&n->sa.sts,g);}}else{do{No*g=ND(WH,lc);if(pm(p,T_ACC)){g->k=N_ACC;g->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;g->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&g->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);g->acc.pmx=ppm(p);}}else{g->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END)&&!pa(p,T_OR)&&!pa(p,T_ELSE))nv(&g->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);}else if(pm(p,T_DEL)){g->k=N_DL;g->ex.cd=pex(p);pe(p,T_SC);}else if(pm(p,T_TER)){g->k=N_TRM;pe(p,T_SC);}else{while(!pa(p,T_OR)&&!pa(p,T_ELSE)&&!pa(p,T_END))nv(&g->hnd.stz,ps(p));}nv(&n->sa.sts,g);}while(pm(p,T_OR));}if(pm(p,T_ELSE))while(!pa(p,T_END))nv(&n->ss.el,ps(p));pe(p,T_END);pe(p,T_SEL);pe(p,T_SC);return n;}
static No*ps(Ps*p){L lc=pl(p);S lb=N;while(pa(p,T_LL)){pn(p);lb=pi(p);pe(p,T_GG);slv(&p->lb,lb);}if(!lb.s&&pa(p,T_ID)&&p->pk.t==T_CL){lb=pi(p);pe(p,T_CL);slv(&p->lb,lb);}if(pa(p,T_IF))return pif(p);if(pa(p,T_CSE))return pcs(p);if(pa(p,T_SEL))return psl(p);if(pa(p,T_LOOP)||pa(p,T_WHI)||pa(p,T_FOR))return plp(p,lb);if(pa(p,T_DEC)||pa(p,T_BEG))return pbk(p,lb);if(pm(p,T_ACC)){No*n=ND(ACC,lc);n->acc.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;n->acc.pmx=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);do nv(&n->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);n->acc.pmx=ppm(p);}}else{pe(p,T_LP);do nv(&n->acc.ixx,pex(p));while(pm(p,T_CM));pe(p,T_RP);n->acc.pmx=ppm(p);}}else{n->acc.pmx=ppm(p);}if(pm(p,T_DO)){while(!pa(p,T_END))nv(&n->acc.stx,ps(p));pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);return n;}if(pm(p,T_DEL)){No*n=ND(DL,lc);n->ex.cd=pex(p);pe(p,T_SC);return n;}if(pm(p,T_AB)){No*n=ND(AB,lc);if(!pa(p,T_SC))n->rs.ec=pnm(p);pe(p,T_SC);return n;}if(pm(p,T_RET)){No*n=ND(RT,lc);if(!pa(p,T_SC))n->rt.vl=pex(p);pe(p,T_SC);return n;}if(pm(p,T_EXIT)){No*n=ND(EX,lc);if(pa(p,T_ID))n->ex.lb=pi(p);if(pm(p,T_WHN))n->ex.cd=pex(p);pe(p,T_SC);return n;}if(pm(p,T_GOTO)){No*n=ND(GT,lc);n->go.lb=pi(p);pe(p,T_SC);return n;}if(pm(p,T_RAS)){No*n=ND(RS,lc);if(!pa(p,T_SC))n->rs.ec=pnm(p);pe(p,T_SC);return n;}if(pm(p,T_NULL)){pe(p,T_SC);return ND(NS,lc);}if(pm(p,T_PGM)){No*n=ND(PG,lc);n->pg.nm=pi(p);if(pm(p,T_LP)){do nv(&n->pg.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);return n;}No*e=pnm(p);if(pm(p,T_AS)){No*n=ND(AS,lc);if(e&&e->k==N_CL){No*fn=e->cl.fn;NV ar=e->cl.ar;e->k=N_IX;e->ix.p=fn;e->ix.ix=ar;}n->as.tg=e;n->as.vl=pex(p);pe(p,T_SC);return n;}No*n=ND(CLT,lc);if(e->k==N_IX){n->ct.nm=e->ix.p;n->ct.arr=e->ix.ix;}else if(e->k==N_CL){n->ct.nm=e->cl.fn;n->ct.arr=e->cl.ar;}else n->ct.nm=e;pe(p,T_SC);return n;}
static NV pst(Ps*p){NV v={0};while(!pa(p,T_END)&&!pa(p,T_EXCP)&&!pa(p,T_ELSIF)&&!pa(p,T_ELSE)&&!pa(p,T_WHN)&&!pa(p,T_OR))nv(&v,ps(p));return v;}
static NV phd(Ps*p){NV v={0};while(pm(p,T_WHN)){L lc=pl(p);No*h=ND(HD,lc);do{if(pm(p,T_OTH)){No*n=ND(ID,lc);n->s=Z("others");nv(&h->hnd.ec,n);}else nv(&h->hnd.ec,pnm(p));}while(pm(p,T_BR));pe(p,T_AR);while(!pa(p,T_WHN)&&!pa(p,T_END))nv(&h->hnd.stz,ps(p));nv(&v,h);}return v;}
static No*ptd(Ps*p){L lc=pl(p);if(pm(p,T_LP)){No*n=ND(TE,lc);do{if(pa(p,T_CHAR)){No*c=ND(CHAR,lc);c->i=p->cr.iv;pn(p);nv(&n->lst.it,c);}else{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&n->lst.it,i);}}while(pm(p,T_CM));pe(p,T_RP);return n;}if(pm(p,T_RNG)){No*n=ND(TI,lc);if(pm(p,T_BX)){n->rn.lo=0;n->rn.hi=0;}else{n->rn.lo=psm(p);pe(p,T_DD);n->rn.hi=psm(p);}return n;}if(pm(p,T_MOD)){No*n=ND(TI,lc);n->un.op=T_MOD;n->un.x=pex(p);return n;}if(pm(p,T_DIG)){No*n=ND(TF,lc);if(pm(p,T_BX))n->un.x=0;else n->un.x=pex(p);if(pm(p,T_RNG)){n->rn.lo=psm(p);pe(p,T_DD);n->rn.hi=psm(p);}return n;}if(pm(p,T_DELTA)){No*n=ND(TX,lc);if(pm(p,T_BX)){n->rn.lo=0;n->rn.hi=0;n->bn.r=0;}else{n->rn.lo=pex(p);pe(p,T_RNG);n->rn.hi=psm(p);pe(p,T_DD);n->bn.r=psm(p);}return n;}if(pm(p,T_ARR)){pe(p,T_LP);No*n=ND(TA,lc);do{No*ix=prn(p);if(ix->k==N_ID&&pm(p,T_RNG)){No*st=ND(ST,lc);st->sd.in=ix;No*cn=ND(CN,lc);cn->cn.rn=prn(p);st->sd.cn=cn;nv(&n->ix.ix,st);}else nv(&n->ix.ix,ix);}while(pm(p,T_CM));pe(p,T_RP);pe(p,T_OF);n->ix.p=psi(p);return n;}if(pm(p,T_REC)){No*n=ND(TR,lc);uint32_t of=0;NV dc={0};if(pm(p,T_LP)){do{S dn=pi(p);pe(p,T_CL);No*dt=pnm(p);No*dd=0;if(pm(p,T_AS))dd=pex(p);No*dp=ND(DS,lc);dp->pm.nm=dn;dp->pm.ty=dt;dp->pm.df=dd;nv(&dc,dp);}while(pm(p,T_SC));pe(p,T_RP);if(!pa(p,T_IS))pe(p,T_SC);}if(pm(p,T_IS)){pe(p,T_REC);}while(!pa(p,T_END)&&!pa(p,T_CSE)&&!pa(p,T_NULL)){NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);No*ty=psi(p);No*in=0;if(pm(p,T_AS))in=pex(p);pe(p,T_SC);for(uint32_t i=0;i<id.n;i++){No*c=ND(CM,lc);c->cm.nm=id.d[i]->s;c->cm.ty=ty;c->cm.in=in;c->cm.of=of++;c->cm.dc=0;c->cm.dsc=0;if(dc.n>0){c->cm.dc=ND(LST,lc);c->cm.dc->lst.it=dc;}nv(&n->lst.it,c);}}if(pm(p,T_NULL)){pe(p,T_SC);}if(pm(p,T_CSE)){No*vp=ND(VP,lc);vp->vp.ds=pnm(p);pe(p,T_IS);while(pm(p,T_WHN)){No*v=ND(VR,lc);do{No*e=pex(p);if(pm(p,T_DD)){No*r=ND(RN,lc);r->rn.lo=e;r->rn.hi=pex(p);e=r;}nv(&v->vr.ch,e);}while(pm(p,T_BR));pe(p,T_AR);while(!pa(p,T_WHN)&&!pa(p,T_END)&&!pa(p,T_NULL)){NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);No*ty=psi(p);No*in=0;if(pm(p,T_AS))in=pex(p);pe(p,T_SC);for(uint32_t i=0;i<id.n;i++){No*c=ND(CM,lc);c->cm.nm=id.d[i]->s;c->cm.ty=ty;c->cm.in=in;c->cm.of=of++;c->cm.dc=0;c->cm.dsc=0;if(dc.n>0){c->cm.dc=ND(LST,lc);c->cm.dc->lst.it=dc;}nv(&v->vr.cmm,c);}}if(pm(p,T_NULL))pe(p,T_SC);nv(&vp->vp.vrr,v);}vp->vp.sz=of;if(pm(p,T_NULL)){pe(p,T_REC);}pe(p,T_END);pe(p,T_CSE);pe(p,T_SC);nv(&n->lst.it,vp);}pe(p,T_END);pe(p,T_REC);return n;}if(pm(p,T_ACCS)){No*n=ND(TAC,lc);n->un.x=psi(p);return n;}if(pm(p,T_PRV))return ND(TP,lc);if(pm(p,T_LIM)){pm(p,T_PRV);return ND(TP,lc);}return psi(p);}
static RC*prc(Ps*p){L lc=pl(p);if(pm(p,T_FOR)){pnm(p);pe(p,T_USE);if(pm(p,T_AT)){RC*r=rc(2,0);pex(p);pe(p,T_SC);return r;}if(pm(p,T_REC)){while(!pa(p,T_END)){pi(p);pe(p,T_AT);pex(p);pe(p,T_RNG);prn(p);pe(p,T_SC);}pe(p,T_END);pe(p,T_REC);pe(p,T_SC);return 0;}pex(p);pe(p,T_SC);return 0;}if(pm(p,T_PGM)){S nm=pi(p);RC*r=0;if(si(nm,Z("SUPPRESS"))){if(pa(p,T_LP)){pe(p,T_LP);S ck=pi(p);uint16_t cm=si(ck,Z("OVERFLOW_CHECK"))?CHK_OVF:si(ck,Z("RANGE_CHECK"))?CHK_RNG:si(ck,Z("INDEX_CHECK"))?CHK_IDX:si(ck,Z("DISCRIMINANT_CHECK"))?CHK_DSC:si(ck,Z("LENGTH_CHECK"))?CHK_LEN:si(ck,Z("DIVISION_CHECK"))?CHK_DIV:si(ck,Z("ELABORATION_CHECK"))?CHK_ELB:si(ck,Z("ACCESS_CHECK"))?CHK_ACC:si(ck,Z("STORAGE_CHECK"))?CHK_STG:0;if(cm){r=rc(4,0);r->ad.nm=pm(p,T_CM)?pi(p):N;while(pm(p,T_CM))pi(p);r->ad.ad=cm;}else{while(pm(p,T_CM))pi(p);}pe(p,T_RP);}pe(p,T_SC);return r;}else if(si(nm,Z("PACK"))){if(pa(p,T_LP)){pe(p,T_LP);S tn=pi(p);while(pm(p,T_CM))pi(p);pe(p,T_RP);r=rc(5,0);r->er.nm=tn;}pe(p,T_SC);return r;}else if(si(nm,Z("INLINE"))){if(pa(p,T_LP)){pe(p,T_LP);r=rc(6,0);r->er.nm=pi(p);while(pm(p,T_CM))pi(p);pe(p,T_RP);}pe(p,T_SC);return r;}else if(si(nm,Z("CONTROLLED"))){if(pa(p,T_LP)){pe(p,T_LP);r=rc(7,0);r->er.nm=pi(p);while(pm(p,T_CM))pi(p);pe(p,T_RP);}pe(p,T_SC);return r;}else if(si(nm,Z("INTERFACE"))){if(pa(p,T_LP)){pe(p,T_LP);r=rc(8,0);r->im.lang=pi(p);if(pm(p,T_CM)){r->im.nm=pi(p);r->im.ext=pm(p,T_CM)?pi(p):N;}pe(p,T_RP);}pe(p,T_SC);return r;}else if(si(nm,Z("OPTIMIZE"))||si(nm,Z("PRIORITY"))||si(nm,Z("STORAGE_SIZE"))||si(nm,Z("SHARED"))||si(nm,Z("LIST"))||si(nm,Z("PAGE"))){if(pm(p,T_LP)){do pex(p);while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);return 0;}else{if(si(nm,Z("ELABORATE"))||si(nm,Z("ELABORATE_ALL"))){pe(p,T_LP);do pi(p);while(pm(p,T_CM));pe(p,T_RP);}else if(pm(p,T_LP)){do pi(p);while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);}}return 0;}
static No*pdl(Ps*p){L lc=pl(p);if(pa(p,T_GEN))return pgf(p);if(pm(p,T_TYP)){S nm=pi(p);No*n=ND(TD,lc);n->td.nm=nm;if(pm(p,T_LP)){No*ds=ND(LST,lc);do{NV dn={0};do{S dnm=pi(p);No*di=ND(ID,lc);di->s=dnm;nv(&dn,di);}while(pm(p,T_CM));pe(p,T_CL);No*dt=pnm(p);No*dd=0;if(pm(p,T_AS))dd=pex(p);for(uint32_t i=0;i<dn.n;i++){No*dp=ND(DS,lc);dp->pm.nm=dn.d[i]->s;dp->pm.ty=dt;dp->pm.df=dd;nv(&ds->lst.it,dp);}}while(pm(p,T_SC));pe(p,T_RP);n->td.dsc=ds->lst.it;}if(pm(p,T_IS)){n->td.nw=pm(p,T_NEW);n->td.drv=n->td.nw;if(n->td.drv){n->td.prt=pnm(p);n->td.df=n->td.prt;if(pm(p,T_DIG)){pex(p);if(pm(p,T_RNG)){psm(p);pe(p,T_DD);psm(p);}}else if(pm(p,T_DELTA)){pex(p);pe(p,T_RNG);psm(p);pe(p,T_DD);psm(p);}else if(pm(p,T_RNG)){No*rn=ND(RN,lc);rn->rn.lo=psm(p);pe(p,T_DD);rn->rn.hi=psm(p);n->td.df=rn;}}else n->td.df=ptd(p);}pe(p,T_SC);return n;}if(pm(p,T_SUB)){S nm=pi(p);pe(p,T_IS);No*n=ND(SD,lc);n->sd.nm=nm;n->sd.in=psi(p);if(n->sd.in->k==N_ST)n->sd.rn=n->sd.in->sd.cn->cn.rn;pe(p,T_SC);return n;}if(pa(p,T_PROC)){No*sp=pps_(p);if(pm(p,T_REN)){pex(p);pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_IS)){if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do{No*e=pex(p);if(e->k==N_ID&&pa(p,T_AR)){pn(p);No*a=ND(ASC,lc);nv(&a->asc.ch,e);a->asc.vl=pex(p);nv(&ap,a);}else{nv(&ap,e);}}while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.gn=gn;n->gi.ap=ap;return n;}No*n=ND(PB,lc);n->bd.sp=sp;n->bd.dc=pdc(p);pe(p,T_BEG);n->bd.st=pst(p);if(pm(p,T_EXCP))n->bd.hdd=phd(p);pe(p,T_END);if(pa(p,T_ID)||pa(p,T_STR))pn(p);pe(p,T_SC);return n;}pe(p,T_SC);No*n=ND(PD,lc);n->bd.sp=sp;return n;}if(pm(p,T_FUN)){S nm;if(pa(p,T_STR)){nm=p->cr.lit;pn(p);}else nm=pi(p);if(pm(p,T_IS)&&pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do{No*e=pex(p);if(e->k==N_ID&&pa(p,T_AR)){pn(p);No*a=ND(ASC,lc);nv(&a->asc.ch,e);a->asc.vl=pex(p);nv(&ap,a);}else{nv(&ap,e);}}while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.gn=gn;n->gi.ap=ap;return n;}No*sp=ND(FS,lc);sp->sp.nm=nm;sp->sp.pmm=ppm(p);pe(p,T_RET);sp->sp.rt=pnm(p);if(pm(p,T_REN)){pex(p);pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}if(pm(p,T_IS)){if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}No*n=ND(FB,lc);n->bd.sp=sp;n->bd.dc=pdc(p);pe(p,T_BEG);n->bd.st=pst(p);if(pm(p,T_EXCP))n->bd.hdd=phd(p);pe(p,T_END);if(pa(p,T_ID)||pa(p,T_STR))pn(p);pe(p,T_SC);return n;}pe(p,T_SC);No*n=ND(FD,lc);n->bd.sp=sp;return n;}if(pm(p,T_PKG)){if(pm(p,T_BOD)){S nm=pi(p);pe(p,T_IS);if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(PKB,lc);n->pb.nm=nm;return n;}No*n=ND(PKB,lc);n->pb.nm=nm;n->pb.dc=pdc(p);if(pm(p,T_BEG)){n->pb.st=pst(p);if(pm(p,T_EXCP))n->pb.hddd=phd(p);}pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}S nm=pi(p);pe(p,T_IS);if(pm(p,T_NEW)){S gn=pi(p);NV ap={0};if(pm(p,T_LP)){do{No*e=pex(p);if(e->k==N_ID&&pa(p,T_AR)){pn(p);No*a=ND(ASC,lc);nv(&a->asc.ch,e);a->asc.vl=pex(p);nv(&ap,a);}else{nv(&ap,e);}}while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);No*n=ND(GINST,lc);n->gi.gn=gn;n->gi.ap=ap;return n;}No*n=ND(PKS,lc);n->ps.nm=nm;n->ps.dc=pdc(p);if(pm(p,T_PRV))n->ps.pr=pdc(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}if(pm(p,T_TSK)){if(pm(p,T_BOD)){S nm=pi(p);pe(p,T_IS);if(pm(p,T_SEP)){pe(p,T_SC);No*n=ND(TKB,lc);n->tb.nm=nm;return n;}No*n=ND(TKB,lc);n->tb.nm=nm;n->tb.dc=pdc(p);pe(p,T_BEG);n->tb.st=pst(p);if(pm(p,T_EXCP))n->tb.hdz=phd(p);pe(p,T_END);if(pa(p,T_ID))pn(p);pe(p,T_SC);return n;}bool it=pm(p,T_TYP);S nm=pi(p);No*n=ND(TKS,lc);n->ts.nm=nm;n->ts.it=it;if(pm(p,T_IS)){while(!pa(p,T_END)){if(pm(p,T_ENT)){No*e=ND(ENT,lc);e->ent.nm=pi(p);if(pa(p,T_LP)){if(p->pk.t==T_ID){Tn scr=p->cr,spk=p->pk;Lx slx=p->lx;pn(p);pn(p);if(p->cr.t==T_CM||p->cr.t==T_CL){p->cr=scr;p->pk=spk;p->lx=slx;e->ent.pmy=ppm(p);}else{p->cr=scr;p->pk=spk;p->lx=slx;pe(p,T_LP);nv(&e->ent.ixy,pnm(p));pe(p,T_RP);e->ent.pmy=ppm(p);}}else{pe(p,T_LP);nv(&e->ent.ixy,pnm(p));pe(p,T_RP);e->ent.pmy=ppm(p);}}else{e->ent.pmy=ppm(p);}pe(p,T_SC);nv(&n->ts.en,e);}else if(pm(p,T_PGM)){pi(p);if(pm(p,T_LP)){do pex(p);while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);}}pe(p,T_END);if(pa(p,T_ID))pn(p);}pe(p,T_SC);return n;}if(pm(p,T_USE)){NV nms={0};do nv(&nms,pnm(p));while(pm(p,T_CM));pe(p,T_SC);if(nms.n==1){No*n=ND(US,lc);n->us.nm=nms.d[0];return n;}No*lst=ND(LST,lc);for(uint32_t i=0;i<nms.n;i++){No*u=ND(US,lc);u->us.nm=nms.d[i];nv(&lst->lst.it,u);}return lst;}if(pm(p,T_PGM)){No*n=ND(PG,lc);n->pg.nm=pi(p);if(pm(p,T_LP)){do nv(&n->pg.ar,pex(p));while(pm(p,T_CM));pe(p,T_RP);}pe(p,T_SC);return n;}{NV id={0};do{S nm=pi(p);No*i=ND(ID,lc);i->s=nm;nv(&id,i);}while(pm(p,T_CM));pe(p,T_CL);bool co=pm(p,T_CONST);if(pm(p,T_EXCP)){No*n=ND(ED,lc);n->ed.id=id;pe(p,T_SC);return n;}No*ty=0;if(!pa(p,T_AS)){if(pa(p,T_ARR)||pa(p,T_ACCS))ty=ptd(p);else ty=psi(p);}No*in=0;if(pm(p,T_REN))in=pex(p);else if(pm(p,T_AS))in=pex(p);pe(p,T_SC);No*n=ND(OD,lc);n->od.id=id;n->od.ty=ty;n->od.in=in;n->od.co=co;return n;}}
static NV pdc(Ps*p){NV v={0};while(!pa(p,T_BEG)&&!pa(p,T_END)&&!pa(p,T_PRV)&&!pa(p,T_EOF)&&!pa(p,T_ENT)){if(pa(p,T_FOR)){RC*r=prc(p);if(r){No*n=ND(RRC,pl(p));memcpy(&n->ag.it.d,&r,sizeof(RC*));nv(&v,n);}continue;}if(pa(p,T_PGM)){RC*r=prc(p);if(r){No*n=ND(RRC,pl(p));memcpy(&n->ag.it.d,&r,sizeof(RC*));nv(&v,n);}continue;}nv(&v,pdl(p));}return v;}
static No*pcx(Ps*p){L lc=pl(p);No*cx=ND(CX,lc);while(pa(p,T_WITH)||pa(p,T_USE)||pa(p,T_PGM)){if(pm(p,T_WITH)){do{No*w=ND(WI,lc);w->wt.nm=pi(p);nv(&cx->cx.wt,w);}while(pm(p,T_CM));pe(p,T_SC);}else if(pm(p,T_USE)){do{No*u=ND(US,lc);u->us.nm=pnm(p);nv(&cx->cx.us,u);}while(pm(p,T_CM));pe(p,T_SC);}else{No*pg=pdl(p);if(pg)nv(&cx->cx.us,pg);}}return cx;}
static No*pcu(Ps*p){L lc=pl(p);No*n=ND(CU,lc);n->cu.cx=pcx(p);while(pa(p,T_WITH)||pa(p,T_USE)||pa(p,T_PROC)||pa(p,T_FUN)||pa(p,T_PKG)||pa(p,T_GEN)||pa(p,T_PGM)){if(pa(p,T_WITH)||pa(p,T_USE)||pa(p,T_PGM))pcx(p);else nv(&n->cu.un,pdl(p));}return n;}
static Ps pnw(const char*s,size_t z,const char*f){Ps p={ln(s,z,f)};pn(&p);pn(&p);return p;}
typedef enum{TY_V=0,TY_I,TY_B,TY_C,TY_F,TY_E,TY_A,TY_R,TY_AC,TY_T,TY_S,TY_P,TY_UI,TY_UF,TY_D,TY_PT,TY_FT,TY_FX}Tk_;
struct Ty{Tk_ k;S nm;Ty*bs,*el,*prt;int64_t lo,hi;NV cm,dc;uint32_t sz,al;SV ev;RV rc;uint64_t ad;bool pk;NV ops;int64_t sm,lg;uint16_t sup;bool ctrl;};
struct Sy{S nm;uint8_t k;Ty*ty;No*df;Sy*nx,*pv;int sc;int64_t vl;uint32_t of;NV ol;SV us;int el;GT*gt;Sy*pr;int lv;bool inl;bool shrd;bool ext;S ext_nm;S ext_lang;};
typedef struct{Sy*sy[4096];int sc;No*ds;No*pk;SV uv;int eo;LV lu;GV gt;jmp_buf*eb[16];int ed;S ce[16];FV io;int fn;SLV lb;int lv;}Sm;
static uint32_t syh(S s){return sh(s)&4095;}
static Sy*syn(S nm,uint8_t k,Ty*ty,No*df){Sy*s=al(sizeof(Sy));s->nm=nm;s->k=k;s->ty=ty;s->df=df;s->el=-1;s->lv=-1;return s;}
static Sy*sya(Sm*SM,Sy*s){uint32_t h=syh(s->nm);s->nx=SM->sy[h];s->sc=SM->sc;s->el=SM->eo++;s->lv=SM->lv;SM->sy[h]=s;return s;}
static Sy*syf(Sm*SM,S nm){Sy*best=0;for(Sy*s=SM->sy[syh(nm)];s;s=s->nx)if(si(s->nm,nm)&&(!best||s->sc>best->sc))best=s;if(!best)for(uint32_t i=0;i<SM->uv.n;i++)for(Sy*u=SM->uv.d[i];u;u=u->nx)if(si(u->nm,nm)&&(!best||u->sc>best->sc))best=u;return best;}
static void sfu(Sm*SM,Sy*s,S nm){for(Sy*p=s;p;p=p->nx)if(si(p->nm,nm)&&p->k==6&&p->df&&p->df->k==N_PKS){No*pk=p->df;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->sy)sv(&s->us,d->sy);}}}
static GT*gfnd(Sm*SM,S nm){for(uint32_t i=0;i<SM->gt.n;i++){GT*g=SM->gt.d[i];if(si(g->nm,nm))return g;}return 0;}
static int tysc(Ty*a,Ty*b,Ty*tx){if(!a||!b)return 0;if(a==b)return 1000;if(a->prt==b||b->prt==a)return 900;if(a->bs==b||b->bs==a)return 800;if((a->k==TY_I||a->k==TY_UI)&&(b->k==TY_I||b->k==TY_UI))return 700;if((a->k==TY_F||a->k==TY_UF)&&(b->k==TY_F||b->k==TY_UF))return 700;if(a->k==TY_AC&&b->k==TY_AC&&a->el&&b->el)return 500+tysc(a->el,b->el,0);if(tx&&a->el&&b==tx)return 400;return 0;}
static Sy*syfa(Sm*SM,S nm,int na,Ty*tx){SV cv={0};for(Sy*s=SM->sy[syh(nm)];s;s=s->nx)if(si(s->nm,nm))sv(&cv,s);for(uint32_t i=0;i<SM->uv.n;i++)for(Sy*u=SM->uv.d[i];u;u=u->nx)if(si(u->nm,nm))sv(&cv,u);if(cv.n==0)return 0;if(cv.n==1)return cv.d[0];Sy*br=0;int bs=-1;for(uint32_t i=0;i<cv.n;i++){Sy*c=cv.d[i];int sc=0;if((c->k==4||c->k==5)&&na>=0){if(c->ol.n>0){for(uint32_t j=0;j<c->ol.n;j++){No*b=c->ol.d[j];if(b->k==N_PB||b->k==N_FB){int np=b->bd.sp->sp.pmm.n;if(np==na){sc+=1000;if(tx&&c->ty&&c->ty->el){int ts=tysc(c->ty->el,tx,0);sc+=ts;}for(uint32_t k=0;k<b->bd.sp->sp.pmm.n&&k<(uint32_t)na;k++){No*p=b->bd.sp->sp.pmm.d[k];if(p->sy&&p->sy->ty&&tx){int ps=tysc(p->sy->ty,tx,0);sc+=ps;}}if(sc>bs){bs=sc;br=c;}}}}}else if(c->k==1){if(na==1){sc=500;if(tx){int ts=tysc(c->ty,tx,0);sc+=ts;}if(sc>bs){bs=sc;br=c;}}}}else if(c->k==1&&na<0){sc=100;if(sc>bs){bs=sc;br=c;}}}return br?br:cv.d[0];}
static Ty*tyn(Tk_ k,S nm){Ty*t=al(sizeof(Ty));t->k=k;t->nm=nm;t->sz=8;t->al=8;return t;}
static Ty*TY_INT,*TY_BOOL,*TY_CHAR,*TY_STR,*TY_FLT,*TY_UINT,*TY_UFLT,*TY_FILE;
static void smi(Sm*SM){memset(SM,0,sizeof(*SM));TY_INT=tyn(TY_I,Z("INTEGER"));TY_INT->lo=-2147483648LL;TY_INT->hi=2147483647LL;TY_BOOL=tyn(TY_B,Z("BOOLEAN"));TY_CHAR=tyn(TY_C,Z("CHARACTER"));TY_CHAR->sz=1;TY_STR=tyn(TY_A,Z("STRING"));TY_STR->el=TY_CHAR;TY_FLT=tyn(TY_F,Z("FLOAT"));TY_UINT=tyn(TY_UI,Z("universal_integer"));TY_UFLT=tyn(TY_UF,Z("universal_real"));TY_FILE=tyn(TY_FT,Z("FILE_TYPE"));sya(SM,syn(Z("INTEGER"),1,TY_INT,0));sya(SM,syn(Z("BOOLEAN"),1,TY_BOOL,0));Sy*st=sya(SM,syn(Z("TRUE"),2,TY_BOOL,0));st->vl=1;sv(&TY_BOOL->ev,st);Sy*sf=sya(SM,syn(Z("FALSE"),2,TY_BOOL,0));sf->vl=0;sv(&TY_BOOL->ev,sf);sya(SM,syn(Z("CHARACTER"),1,TY_CHAR,0));sya(SM,syn(Z("STRING"),1,TY_STR,0));sya(SM,syn(Z("FLOAT"),1,TY_FLT,0));sya(SM,syn(Z("FILE_TYPE"),1,TY_FILE,0));sya(SM,syn(Z("CONSTRAINT_ERROR"),3,0,0));sya(SM,syn(Z("PROGRAM_ERROR"),3,0,0));sya(SM,syn(Z("STORAGE_ERROR"),3,0,0));sya(SM,syn(Z("TASKING_ERROR"),3,0,0));fv(&SM->io,stdin);fv(&SM->io,stdout);fv(&SM->io,stderr);SM->fn=3;}
static void scp(Sm*SM){SM->sc++;}
static void sco(Sm*SM){for(int i=0;i<4096;i++){Sy**p=&SM->sy[i];while(*p){if((*p)->sc==SM->sc&&(*p)->k!=4&&(*p)->k!=5&&!((*p)->k==0&&(*p)->el>=0))*p=(*p)->nx;else p=&(*p)->nx;}}SM->sc--;}
