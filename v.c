#define V(c,l,...)if(!(c))die(l,__VA_ARGS__)
static void vt(Sm*M,Ty*t,L l){V(t,l,"?ty");if(t->k==TY_AC){Ty*e=tcc(t->el);V(e->k!=TY_FX,l,"fx ac");V(e->k!=TY_E,l,"enum ac");V(e->k!=TY_I||!e->prt,l,"int ac");V(e->k!=TY_F,l,"flt ac");V(e->k!=TY_A,l,"arr ac");V(e->k!=TY_R,l,"rec ac");V(e->k!=TY_AC,l,"ac ac");V(e->k!=TY_T,l,"tsk ac");V(e->k!=TY_P,l,"pkg ac");}}
static void ve(Sm*M,No*n,L l){if(!n)return;switch(n->k){case N_ID:V(n->sy||syf(M,n->s),l,"?'%.*s'",(int)n->s.n,n->s.s);break;case N_SEL:{No*p=n->se.p;if(p&&p->k==N_ID){Sy*s=syf(M,p->s);V(s,l,"?pfx '%.*s'",(int)p->s.n,p->s.s);if(s&&s->k==6&&s->df&&s->df->k==N_PKS){No*pk=s->df;bool f=0;for(uint32_t i=0;i<pk->ps.dc.n;i++){No*d=pk->ps.dc.d[i];if(d->sy&&si(d->sy->nm,n->se.se)){f=1;break;}}V(f,l,"?'%.*s' in pkg",(int)n->se.se.n,n->se.se.s);}}}break;case N_BIN:ve(M,n->bn.l,l);ve(M,n->bn.r,l);if(n->bn.op>=T_PL&&n->bn.op<=T_SL){Ty*lt=n->bn.l->ty?tcc(n->bn.l->ty):0;Ty*rt=n->bn.r->ty?tcc(n->bn.r->ty):0;V(!lt||!rt||tco(lt,rt),l,"ty mismatch");}break;case N_CL:ve(M,n->cl.fn,l);for(uint32_t i=0;i<n->cl.ar.n;i++)ve(M,n->cl.ar.d[i],l);if(n->cl.fn&&n->cl.fn->k==N_ID){Sy*s=syfa(M,n->cl.fn->s,n->cl.ar.n,0);V(s&&(s->k==5||s->k==1),l,"?fn '%.*s'",(int)n->cl.fn->s.n,n->cl.fn->s.s);}break;case N_UN:ve(M,n->un.x,l);break;case N_IX:ve(M,n->ix.p,l);for(uint32_t i=0;i<n->ix.ix.n;i++)ve(M,n->ix.ix.d[i],l);break;case N_AT:ve(M,n->at.p,l);for(uint32_t i=0;i<n->at.ar.n;i++)ve(M,n->at.ar.d[i],l);break;case N_AG:for(uint32_t i=0;i<n->ag.it.n;i++)ve(M,n->ag.it.d[i],l);break;case N_DRF:ve(M,n->drf.x,l);if(n->drf.x&&n->drf.x->ty){Ty*t=tcc(n->drf.x->ty);V(t->k==TY_AC,l,".all non-ac");}break;default:break;}}
static void vs(Sm*M,No*n,L l){if(!n)return;switch(n->k){case N_AS:ve(M,n->as.tg,l);ve(M,n->as.vl,l);break;case N_IF:ve(M,n->if_.cd,l);for(uint32_t i=0;i<n->if_.th.n;i++)vs(M,n->if_.th.d[i],l);for(uint32_t i=0;i<n->if_.ei.n;i++){No*e=n->if_.ei.d[i];ve(M,e->if_.cd,l);for(uint32_t j=0;j<e->if_.th.n;j++)vs(M,e->if_.th.d[j],l);}for(uint32_t i=0;i<n->if_.el.n;i++)vs(M,n->if_.el.d[i],l);break;case N_CS:ve(M,n->cs.ex,l);for(uint32_t i=0;i<n->cs.al.n;i++){No*a=n->cs.al.d[i];for(uint32_t j=0;j<a->hnd.stz.n;j++)vs(M,a->hnd.stz.d[j],l);}break;case N_LP:if(n->lp.it)ve(M,n->lp.it,l);for(uint32_t i=0;i<n->lp.st.n;i++)vs(M,n->lp.st.d[i],l);break;case N_BL:for(uint32_t i=0;i<n->bk.st.n;i++)vs(M,n->bk.st.d[i],l);break;case N_RT:if(n->rt.vl)ve(M,n->rt.vl,l);break;default:break;}}
static void vd(Sm*M,No*n,L l){if(!n)return;switch(n->k){case N_TD:if(n->td.df&&n->td.df->k==N_TAC)vt(M,rst(M,n->td.df),l);if(n->td.dsc.n){for(uint32_t i=0;i<n->td.dsc.n;i++){No*d=n->td.dsc.d[i];if(d->k==N_DS&&d->pm.df)ve(M,d->pm.df,l);}}if(n->td.drv&&n->td.prt){Sy*p=n->td.prt->k==N_ID?syf(M,n->td.prt->s):0;V(p&&p->k==1,l,"der non-ty");}break;case N_SD:if(n->sd.rn){ve(M,n->sd.rn->rn.lo,l);ve(M,n->sd.rn->rn.hi,l);}break;case N_OD:if(n->od.in)ve(M,n->od.in,l);for(uint32_t i=0;i<n->od.id.n;i++){No*id=n->od.id.d[i];Sy*s=syf(M,id->s);if(s&&s->sc==M->sc&&s->k!=11)die(l,"dup '%.*s'",(int)id->s.n,id->s.s);}break;case N_PB:for(uint32_t i=0;i<n->bd.st.n;i++)vs(M,n->bd.st.d[i],l);break;case N_FB:for(uint32_t i=0;i<n->bd.st.n;i++)vs(M,n->bd.st.d[i],l);break;default:break;}}
